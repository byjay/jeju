<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ê·€ì„ ë‹˜ì„ìœ„í•œ ì œì£¼ì—¬í–‰ í”Œë˜ë„ˆ </title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkmhTzFKcxxfQIrYlkcFjXAgIDdTZMdvU&callback=initApp&libraries=places,directions,geometry&v=weekly" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f7fafc; }
        .day-tab.active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .option-card { transition: all 0.2s ease-in-out; border-width: 2px; }
        .option-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .option-card.selected { border-color: #6366f1; background-color: #eef2ff; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        .details-panel { overflow: hidden; transition: all 0.3s ease-in-out; height: 0; margin-top: 0; opacity: 0; display: flex; gap: 1rem;}
        .details-panel.open { margin-top: 1rem; opacity: 1; }
        .details-section { flex: 1; min-width: 0; }
        .loading-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px; color: #6b7280; text-align: center;}
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-bottom: 0.5rem;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #navi-mode-toggle.active { background-color: #10b981; }
        .distance-info { font-size: 0.75rem; font-weight: 600; color: #10b981; margin-left: auto; }
        .input-cost-field { width: 100%; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8rem; text-align: right; }
        .compact-timeline { padding-left: 1.5rem; }
        .timeline-dot { left: -6px; width: 12px; height: 12px; }
        
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; flex-direction: column; }
        .fullscreen-modal.active { display: flex; }
        .fullscreen-header { flex-shrink: 0; background-color: #1f2937; color: white; }
        .fullscreen-content { flex-grow: 1; display: flex; overflow: hidden; }
        .fullscreen-map-container { flex-grow: 1; position: relative; }
        .fullscreen-map { width: 100%; height: 100%; }
        .map-sidebar { width: 400px; flex-shrink: 0; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; }
        .place-card { cursor: pointer; border-bottom: 1px solid #e5e7eb; padding: 1rem; transition: background-color 0.2s; }
        .place-card:hover { background-color: #f9fafb; }
        .place-card.selected { background-color: #dbeafe; border-left: 4px solid #3b82f6; }

        .category-btn { background-color: #e5e7eb; color: #374151; }
        .category-btn.active { background-color: #4f46e5; color: white; }

        .place-detail-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 10002; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: none; }
        .place-detail-modal.active { display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: none; }
        .modal-overlay.active { display: block; }

        @media (max-width: 1024px) {
            .fullscreen-content { flex-direction: column-reverse; }
            .map-sidebar { width: 100%; height: 50%; }
            .fullscreen-map-container { height: 50%; }
        }
        @media (max-width: 768px) {
            .details-panel { flex-direction: column; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg no-print">
        <div class="max-w-screen-xl mx-auto px-4 py-4 text-center">
            <h1 class="text-3xl font-bold">ğŸï¸ ê°•ê·€ì„ ë‹˜ì„ ìœ„í•œ ì œì£¼ì—¬í–‰ í”Œë˜ë„ˆ by bong</h1>
            <p class="text-lg mt-1 opacity-90">ìš°ë¦¬ì§‘ ë¨¹íˆ¬ì–´ë¥¼ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ í”Œë˜ë„ˆ </p>
        </div>
    </div>

    <div class="max-w-screen-xl mx-auto p-3">
        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="flex flex-wrap justify-center items-center mb-4 bg-white p-2 rounded-xl shadow-md gap-2 no-print">
            <div class="flex-grow flex justify-center" id="day-tabs-container"></div>
            <button id="theme-search-toggle" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-search-location mr-2"></i>ì œì£¼ ì „ì²´ ì¥ì†Œ ê²€ìƒ‰
            </button>
            <button id="reset-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-undo mr-2"></i>ë¦¬ì…‹
            </button>
            <button id="navi-mode-toggle" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-location-arrow mr-2"></i>Live GPS
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
            <!-- ì¼ì • íŒ¨ë„ -->
            <div id="itinerary-container" class="lg:col-span-4 space-y-4"></div>
            
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="lg:col-span-3">
                <div class="sticky top-4 space-y-4">
                    <!-- ì§€ë„ -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-map-marked-alt mr-2"></i>ì‹¤ì‹œê°„ ì§€ë„ & ê²½ë¡œ</h3>
                        <div id="map" class="w-full h-64 bg-gray-200"></div>
                        <div class="p-3"><button onclick="openInGoogleMaps()" class="w-full bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-700 transition text-sm"><i class="fas fa-directions mr-1"></i>êµ¬ê¸€ë§µì—ì„œ ê¸¸ì°¾ê¸°</button></div>
                    </div>
                    <!-- ì„ íƒ ì¼ì • -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-tasks mr-2"></i>ì˜¤ëŠ˜ì˜ ì—¬í–‰ ê³„íš</h3>
                        <div id="selected-items-container" class="p-3 max-h-48 overflow-y-auto"></div>
                    </div>
                    <!-- ê²½ë¹„ ê³„ì‚° -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-coins mr-2"></i>ì—¬í–‰ ê²½ë¹„ ê³„ì‚°</h3>
                        <div class="p-3 space-y-3">
                             <div>
                                <h4 class="font-semibold text-gray-700 mb-2 text-sm">ì§ì ‘ ì…ë ¥</h4>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div><label for="flight-cost" class="block text-gray-600 mb-1">í•­ê³µë£Œ</label><input type="number" id="flight-cost" class="input-cost-field" placeholder="400,000" step="10000"></div>
                                    <div><label for="hotel-cost" class="block text-gray-600 mb-1">ìˆ™ë°•ë¹„</label><input type="number" id="hotel-cost" class="input-cost-field" placeholder="500,000" step="10000"></div>
                                </div>
                            </div>
                            <div class="border-t pt-3">
                                <h4 class="font-semibold text-gray-700 mb-2 text-sm">í˜„ì§€ ê²½ë¹„</h4>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between items-center"><span class="text-gray-600">ğŸ´ ì‹ë¹„/ì¹´í˜</span><span class="font-semibold" id="cost-food">â‚©0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">ğŸŸï¸ ì²´í—˜/ê´€ê´‘</span><span class="font-semibold" id="cost-activity">â‚©0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">ğŸš— ê¸°íƒ€</span><span class="font-semibold" id="cost-etc">â‚©0</span></div>
                                </div>
                            </div>
                            <div class="pt-3 border-t-2 text-center bg-yellow-50 p-2 rounded-lg">
                                <p class="text-xs text-gray-600">ì´ ì˜ˆìƒ ì—¬í–‰ ê²½ë¹„</p>
                                <p class="text-xl font-bold text-red-600" id="total-cost">â‚©0</p>
                            </div>
                        </div>
                    </div>
                    <!-- ìˆ™ì†Œ ì •ë³´ -->
                    <div class="bg-white rounded-xl shadow-lg">
                         <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-bed mr-2"></i>ì¶”ì²œ ìˆ™ì†Œ</h3>
                         <div class="p-3 space-y-2 text-xs">
                            <div class="border-b pb-2"><p class="font-semibold">1ì¼ì°¨ ìˆ™ì†Œ</p><a href="https://www.agoda.com/sl/cmP0tfukS0y" target="_blank" class="text-blue-600 hover:underline">ì²´í¬ì¸í˜¸í…” ì œì£¼</a></div>
                            <div class="border-b pb-2"><p class="font-semibold">2ì¼ì°¨ ìˆ™ì†Œ</p><a href="https://www.agoda.com/sl/GPG0yhcNtzR" target="_blank" class="text-blue-600 hover:underline">ë” í¼ìŠ¤íŠ¸ 70 í˜¸í…”</a></div>
                            <div><p class="font-semibold">3ì¼ì°¨ ìˆ™ì†Œ</p><a href="https://www.agoda.com/sl/Hl5xYmPAnWn" target="_blank" class="text-blue-600 hover:underline">íŒí¬í¬êµ¬ í”„ë¦¬ë¯¸ì—„ ìŠ¤í…Œì´</a></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì „ì²´í™”ë©´ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="fullscreen-modal" class="fullscreen-modal">
        <div class="fullscreen-header p-4 flex justify-between items-center"><h2 class="text-xl font-bold">ì œì£¼ ì „ì²´ ì¥ì†Œ ê²€ìƒ‰</h2><button id="close-fullscreen" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-times mr-2"></i>ë‹«ê¸°</button></div>
        <div class="fullscreen-content">
            <div class="map-sidebar">
                <div class="sidebar-header">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="theme-keyword-search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰ (ì˜ˆ: í‘ë¼ì§€)">
                        <button id="theme-search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="theme-category-buttons" class="grid grid-cols-4 gap-2">
                        <button data-category="all" class="category-btn py-2 rounded-lg text-sm font-semibold transition active">ì „ì²´</button>
                        <button data-category="food" class="category-btn py-2 rounded-lg text-sm font-semibold transition">ë§›ì§‘</button>
                        <button data-category="cafe" class="category-btn py-2 rounded-lg text-sm font-semibold transition">ì¹´í˜</button>
                        <button data-category="activity" class="category-btn py-2 rounded-lg text-sm font-semibold transition">ê´€ê´‘/ì²´í—˜</button>
                    </div>
                </div>
                <div id="search-results" class="sidebar-content"></div>
            </div>
            <div class="fullscreen-map-container"><div id="fullscreen-map" class="fullscreen-map"></div></div>
        </div>
    </div>
    
    <!-- [ë³µì›] ìƒì„¸ ì •ë³´ íŒì—… ëª¨ë‹¬ -->
    <div id="modal-overlay" class="modal-overlay"></div>
    <div id="place-detail-modal" class="place-detail-modal">
        <div class="flex justify-between items-center mb-4"><h2 id="place-name" class="text-xl font-bold"></h2><button id="close-detail-modal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
        <div id="place-details" class="space-y-4"></div>
    </div>

<script>
// --- [ìµœì¢…] ë°ì´í„°ë² ì´ìŠ¤: ëª¨ë“  ì¥ì†Œ ì •ë³´ í†µí•© ë° ê°•í™” ---
const allJejuPlaces = [
    // ë™ë¶€
    {id: 'p_snoopy', name: 'ìŠ¤ëˆ„í”¼ê°€ë“ ', type: 'activity', region: 'east', lat: 33.4253, lng: 126.7958, cost: 18000, tags: ['í…Œë§ˆíŒŒí¬', 'í”¼ë„ˆì¸ '], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 18000}, {item: 'ì²­ì†Œë…„', price: 15000}, {item: 'ì–´ë¦°ì´', price: 12000}]},
    {id: 'p_ecoland', name: 'ì—ì½”ëœë“œ', type: 'activity', region: 'east', lat: 33.4533, lng: 126.6713, cost: 14000, tags: ['ê¸°ì°¨', 'ê³¶ìì™ˆ'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 14000}, {item: 'ì²­ì†Œë…„', price: 12000}, {item: 'ì–´ë¦°ì´', price: 10000}]},
    {id: 'p_ilchul', name: 'ì¼ì¶œëœë“œ', type: 'activity', region: 'east', lat: 33.3643, lng: 126.8631, cost: 9000, tags: ['ë¯¸ì²œêµ´', 'ìˆ˜ëª©ì›'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 9000}, {item: 'ì²­ì†Œë…„', price: 6000}, {item: 'ì–´ë¦°ì´', price: 5000}]},
    {id: 'p_seopjikoji', name: 'ì„­ì§€ì½”ì§€', type: 'activity', region: 'east', lat: 33.4238, lng: 126.9317, cost: 0, tags: ['ìì—°', 'í•´ì•ˆ', 'ê´€ê´‘ì§€'], menu: [{item: 'ì…ì¥ë£Œ', price: 0}]},
    {id: 'p_seongsan', name: 'ì„±ì‚°ì¼ì¶œë´‰', type: 'activity', region: 'east', lat: 33.4581, lng: 126.9427, cost: 5000, tags: ['ì„¸ê³„ìì—°ìœ ì‚°', 'ì˜¤ë¦„', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 5000}, {item: 'ì²­ì†Œë…„/ì–´ë¦°ì´', price: 2500}]},
    {id: 'p_bijarim', name: 'ë¹„ìë¦¼', type: 'activity', region: 'east', lat: 33.4893, lng: 126.8117, cost: 3000, tags: ['ìˆ²ê¸¸', 'ì²œë…„ì˜ìˆ²', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 3000}, {item: 'ì²­ì†Œë…„/ì–´ë¦°ì´', price: 1500}]},
    {id: 'p_maze', name: 'ë©”ì´ì¦ˆëœë“œ', type: 'activity', region: 'east', lat: 33.5042, lng: 126.7865, cost: 11000, tags: ['ë¯¸ë¡œê³µì›', 'ëŒë¯¸ë¡œ', 'ì²´í—˜'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 11000}, {item: 'ì²­ì†Œë…„', price: 9000}, {item: 'ì–´ë¦°ì´', price: 8000}]},
    {id: 'p_haenyeo', name: 'í•´ë…€ë°•ë¬¼ê´€', type: 'activity', region: 'east', lat: 33.5350, lng: 126.8559, cost: 1100, tags: ['ë°•ë¬¼ê´€', 'í•´ë…€ë¬¸í™”', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 1100}]},
    {id: 'p_aquaplanet', name: 'ì•„ì¿ ì•„í”Œë¼ë„· ì œì£¼', type: 'activity', region: 'east', lat: 33.4310, lng: 126.9272, cost: 42400, tags: ['ìˆ˜ì¡±ê´€', 'ì˜¤ì…˜ì•„ë ˆë‚˜', 'ì²´í—˜'], menu: [{item: 'ì¢…í•©ê¶Œ(ì„±ì¸)', price: 42400}, {item: 'ì¢…í•©ê¶Œ(ì²­ì†Œë…„/ê²½ë¡œ)', price: 40800}]},
    {id: 'p_folk', name: 'ì œì£¼ë¯¼ì†ì´Œ', type: 'activity', region: 'east', lat: 33.3196, lng: 126.9099, cost: 15000, tags: ['ì „í†µê°€ì˜¥', 'ì—­ì‚¬', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 15000}, {item: 'ì²­ì†Œë…„/ê²½ë¡œ', price: 12000}, {item: 'ì–´ë¦°ì´', price: 11000}]},
    {id: 'p_skywater', name: 'ìŠ¤ì¹´ì´ì›Œí„°ì‡¼', type: 'activity', region: 'east', lat: 33.3941, lng: 126.7937, cost: 20000, tags: ['ê³µì—°', 'ì‹¤ë‚´', 'ì²´í—˜'], menu: [{item: 'ê³µì—°ê´€ëŒê¶Œ', price: 20000}]},
    {id: 'p_plnt827', name: 'í”Œë˜ë‹›827', type: 'cafe', region: 'east', lat: 33.4300, lng: 126.9230, cost: 20000, tags: ['ë² ì´ì»¤ë¦¬', 'ì˜¤ì…˜ë·°'], menu: [{item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 6500}, {item: 'ëŒí•˜ë¥´ë°© ì¼€ì´í¬', price: 9500, recommended: true}]},
    {id: 'p_orrrn', name: 'ì˜¤ë¥´ë¡¸', type: 'cafe', region: 'east', lat: 33.4612, lng: 126.9388, cost: 20000, tags: ['ì„±ì‚°ë·°', 'ë£¨í”„íƒ‘'], menu: [{item: 'ì•„ì¸ìŠˆí˜ë„ˆ', price: 8000, recommended: true}, {item: 'ì œì£¼ ë‹¹ê·¼ ì¼€ì´í¬', price: 8500}]},
    {id: 'p_gamgyul', name: 'ê·¤ê½ƒì¹´í˜', type: 'cafe', region: 'east', lat: 33.5011, lng: 126.7834, cost: 18000, tags: ['ê°ê·¤ë°­', 'í¬í† ì¡´'], menu: [{item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 5000}, {item: 'ê°ê·¤ì£¼ìŠ¤', price: 7000}]},
    {id: 'p_myeongjin', name: 'ëª…ì§„ì „ë³µ', type: 'food', region: 'east', lat: 33.5323, lng: 126.8624, cost: 60000, tags: ['ì „ë³µ', 'í–¥í† ìŒì‹'], menu: [{item: 'ì „ë³µ ëŒì†¥ë°¥', price: 16000, recommended: true}, {item: 'ì „ë³µì£½', price: 13000}, {item: 'ì „ë³µ êµ¬ì´', price: 30000}]},

    // ì„œë¶€
    {id: 'p_osulloc', name: 'ì˜¤ì„¤ë¡ í‹° ë®¤ì§€ì—„', type: 'activity', region: 'west', lat: 33.3059, lng: 126.2895, cost: 0, tags: ['ë…¹ì°¨ë°­', 'ë®¤ì§€ì—„', 'ê´€ê´‘ì§€'], menu: [{item: 'ì…ì¥ë£Œ', price: 0}, {item: 'ë…¹ì°¨ ì•„ì´ìŠ¤í¬ë¦¼', price: 5500}, {item: 'ê·¸ë¦°í‹° ë¡¤ì¼€ìµ', price: 6500}]},
    {id: 'p_shinhwa', name: 'ì‹ í™”ì›”ë“œ', type: 'activity', region: 'west', lat: 33.3000, lng: 126.3150, cost: 45000, tags: ['í…Œë§ˆíŒŒí¬', 'ë¦¬ì¡°íŠ¸', 'ì²´í—˜'], menu: [{item: 'í…Œë§ˆíŒŒí¬ BIG3', price: 30000}, {item: 'ì›Œí„°íŒŒí¬ ì¢…ì¼ê¶Œ', price: 45000}]},
    {id: 'p_arte', name: 'ì•„ë¥´ë–¼ë®¤ì§€ì—„', type: 'activity', region: 'west', lat: 33.4116, lng: 126.3059, cost: 17000, tags: ['ë¯¸ë””ì–´ì•„íŠ¸', 'ì‹¤ë‚´', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 17000}, {item: 'ì²­ì†Œë…„', price: 13000}, {item: 'ì–´ë¦°ì´', price: 10000}]},
    {id: 'p_981', name: '9.81íŒŒí¬', type: 'activity', region: 'west', lat: 33.4147, lng: 126.3228, cost: 59000, tags: ['ë ˆì´ì‹±', 'ì•¡í‹°ë¹„í‹°', 'ì²´í—˜'], menu: [{item: 'RACE 981 3íšŒê¶Œ', price: 49500}, {item: 'í’€íŒ¨í‚¤ì§€', price: 59000}]},
    {id: 'p_glass', name: 'ìœ ë¦¬ì˜ì„±', type: 'activity', region: 'west', lat: 33.3294, lng: 126.2753, cost: 12000, tags: ['ìœ ë¦¬ê³µì˜ˆ', 'í¬í† ì¡´', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 12000}, {item: 'ì²­ì†Œë…„/ì–´ë¦°ì´', price: 10000}]},
    {id: 'p_hallimpark', name: 'í•œë¦¼ê³µì›', type: 'activity', region: 'west', lat: 33.3912, lng: 126.2396, cost: 15000, tags: ['í˜‘ì¬êµ´', 'ì•¼ììˆ˜ê¸¸', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 15000}, {item: 'ì²­ì†Œë…„', price: 10000}, {item: 'ì–´ë¦°ì´', price: 9000}]},
    {id: 'p_norimae', name: 'ë…¸ë¦¬ë§¤ê³µì›', type: 'activity', region: 'west', lat: 33.3236, lng: 126.3184, cost: 9000, tags: ['ë§¤í™”', 'ì‚¬ì§„ëª…ì†Œ', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 9000}]},
    {id: 'p_hyeopjae', name: 'í˜‘ì¬í•´ìˆ˜ìš•ì¥', type: 'activity', region: 'west', lat: 33.3941, lng: 126.2394, cost: 0, tags: ['ë°”ë‹¤', 'ë¹„ì–‘ë„ë·°', 'ê´€ê´‘ì§€'], menu: [{item: 'ì…ì¥ë£Œ', price: 0}]},
    {id: 'p_themama', name: 'ë”ë§ˆíŒŒí¬', type: 'activity', region: 'west', lat: 33.4005, lng: 126.3056, cost: 18000, tags: ['ë§ê³µì—°', 'ì¹´íŠ¸', 'ì²´í—˜'], menu: [{item: 'ë§ê³µì—° ê´€ëŒ', price: 18000}, {item: 'ì¹´íŠ¸ 1ì¸', price: 25000}]},
    {id: 'p_saebiloreum', name: 'ìƒˆë³„ì˜¤ë¦„', type: 'activity', region: 'west', lat: 33.3664, lng: 126.3533, cost: 0, tags: ['ì˜¤ë¦„', 'ì–µìƒˆ', 'ê´€ê´‘ì§€'], menu: [{item: 'ì…ì¥ë£Œ', price: 0}]},
    {id: 'p_aewolcafe', name: 'ì•„ì´ìœ ìŠ¤ë®¤ì§€ì—„', type: 'activity', region: 'west', lat: 33.4735, lng: 126.3888, cost: 15000, tags: ['ì–¼ìŒë™êµ´', 'í¬í† ì¡´', 'ì²´í—˜'], menu: [{item: '3D+5D+VR 1íšŒ', price: 15000}]},
    {id: 'p_bomnal', name: 'ë´„ë‚ ì¹´í˜', type: 'cafe', region: 'west', lat: 33.4635, lng: 126.3107, cost: 20000, tags: ['ì˜¤ì…˜ë·°', 'ìœ ëª…ì¹´í˜'], menu: [{item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 5000}, {item: 'í•œë¼ë´‰ì—ì´ë“œ', price: 8000, recommended: true}, {item: 'ë•…ì½©ë¼ë–¼', price: 7000}]},
    {id: 'p_randys', name: 'ëœë””ìŠ¤ë„ë„›', type: 'cafe', region: 'west', lat: 33.4627, lng: 126.3853, cost: 20000, tags: ['ë„ë„›', 'ì›¨ì´íŒ…'], menu: [{item: 'ê¸€ë ˆì´ì¦ˆ ë„ë„›', price: 2500}, {item: 'ì— ì•¤ì—  ë„ë„›', price: 3500, recommended: true}, {item: 'í…ì‚¬ìŠ¤ ë„ë„›', price: 3300}]},
    {id: 'p_saebilcafe', name: 'ìƒˆë¹Œì¹´í˜', type: 'cafe', region: 'west', lat: 33.3725, lng: 126.3518, cost: 22000, tags: ['ìƒˆë³„ì˜¤ë¦„ë·°', 'ëŒ€í˜•ì¹´í˜'], menu: [{item: 'ìƒˆë¹Œ ì‹œê·¸ë‹ˆì²˜', price: 8500, recommended: true}, {item: 'íŒ¡ë„ë¥´', price: 7000}, {item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 6000}]},
    {id: 'p_korikocafe', name: 'ì½”ë¦¬ì½”ì¹´í˜ ì œì£¼ì ', type: 'cafe', region: 'west', lat: 33.4566, lng: 126.3050, cost: 22000, tags: ['ì§€ë¸Œë¦¬', 'ìºë¦­í„°'], menu: [{item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 6000}, {item: 'ì´ˆì½” ì¼€ì´í¬', price: 9000, recommended: true}, {item: 'í”Œë¼ì›Œ ì—ì´ë“œ', price: 7500}]},

    // ë‚¨ë¶€ & ì„œê·€í¬
    {id: 'p_cheonjeyeon', name: 'ì²œì œì—°í­í¬', type: 'activity', region: 'south', lat: 33.2503, lng: 126.4215, cost: 2500, tags: ['í­í¬', 'ì„ ì„êµ', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 2500}, {item: 'ì²­ì†Œë…„/ì–´ë¦°ì´', price: 1350}]},
    {id: 'p_jusangjeolli', name: 'ì£¼ìƒì ˆë¦¬ëŒ€', type: 'activity', region: 'south', lat: 33.2384, lng: 126.4247, cost: 2000, tags: ['ìì—°ê²½ê´€', 'í™”ì‚°ì§€í˜•', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 2000}]},
    {id: 'p_camellia', name: 'ì¹´ë©œë¦¬ì•„í', type: 'activity', region: 'south', lat: 33.2913, lng: 126.3688, cost: 10000, tags: ['ë™ë°±ê½ƒ', 'ìˆ˜êµ­', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 10000}, {item: 'ì²­ì†Œë…„', price: 8000}, {item: 'ì–´ë¦°ì´', price: 7000}]},
    {id: 'p_wind1947', name: 'ìœˆë“œ1947ì¹´íŠ¸', type: 'activity', region: 'south', lat: 33.2758, lng: 126.5516, cost: 35000, tags: ['ì¹´íŠ¸', 'ì•¡í‹°ë¹„í‹°', 'ì²´í—˜'], menu: [{item: 'ì„±ì¸ ì¹´íŠ¸ 3íšŒì „', price: 35000}, {item: '2ì¸ìŠ¹ ì¹´íŠ¸', price: 45000}]},
    {id: 'p_hueree', name: 'íœ´ì• ë¦¬', type: 'activity', region: 'south', lat: 33.2872, lng: 126.6025, cost: 13000, tags: ['ìì—°ê³µì›', 'ë™ë¬¼ì²´í—˜', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 13000}, {item: 'í‘ë¼ì§€ì‡¼ ê´€ëŒ í¬í•¨', price: 0}]},
    {id: 'p_yakcheonsa', name: 'ì•½ì²œì‚¬', type: 'activity', region: 'south', lat: 33.2429, lng: 126.4678, cost: 0, tags: ['ì‚¬ì°°', 'ê±´ì¶•', 'ê´€ê´‘ì§€'], menu: [{item: 'ì…ì¥ë£Œ', price: 0}]},
    {id: 'p_alive', name: 'ë°•ë¬¼ê´€ì€ì‚´ì•„ìˆë‹¤', type: 'activity', region: 'south', lat: 33.2505, lng: 126.4111, cost: 12000, tags: ['íŠ¸ë¦­ì•„íŠ¸', 'ì‹¤ë‚´', 'ì²´í—˜'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 12000}]},
    {id: 'p_teddy', name: 'í…Œë””ë² ì–´ë®¤ì§€ì—„', type: 'activity', region: 'south', lat: 33.2500, lng: 126.4120, cost: 12000, tags: ['ì¸í˜•', 'ë°•ë¬¼ê´€', 'ê´€ê´‘ì§€'], menu: [{item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 12000}]},
    {id: 'p_vadada', name: 'ë°”ë‹¤ë‹¤', type: 'cafe', region: 'south', lat: 33.2388, lng: 126.4447, cost: 30000, tags: ['ë¼ìš´ì§€', 'ì˜¤ì…˜ë·°'], menu: [{item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 10000}, {item: 'ëª¨íˆë˜', price: 15000, recommended: true}, {item: 'í”¼ì', price: 25000}]},
    {id: 'p_oneandonly', name: 'ì›ì•¤ì˜¨ë¦¬', type: 'cafe', region: 'south', lat: 33.2443, lng: 126.3725, cost: 25000, tags: ['ì‚°ë°©ì‚°ë·°', 'ì•¼ììˆ˜'], menu: [{item: 'ì‚°ë°©ì‚° ì¼€ì´í¬', price: 12000, recommended: true}, {item: 'í”¼ë„› ë¼ë–¼', price: 9000}, {item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 7000}]},
    {id: 'p_deokseong', name: 'ë•ì„±ì›', type: 'food', region: 'south', lat: 33.2494, lng: 126.5615, cost: 50000, tags: ['ì¤‘ì‹', 'ê½ƒê²Œì§¬ë½•'], menu: [{item: 'ê½ƒê²Œì§¬ë½•', price: 12000, recommended: true}, {item: 'ì§œì¥ë©´', price: 7000}, {item: 'íƒ•ìˆ˜ìœ¡(ì†Œ)', price: 22000}]},
    {id: 'p_ollehmarket', name: 'ì˜¬ë ˆì‹œì¥', type: 'food', region: 'south', lat: 33.2497, lng: 126.5654, cost: 40000, tags: ['ì‹œì¥', 'í–¥í† ìŒì‹'], menu: [{item: 'ë§ˆë†ì¹˜í‚¨', price: 19000, recommended: true}, {item: 'ëª¨ë‹¥ì¹˜ê¸°', price: 10000}, {item: 'í‘ë¼ì§€ ê¼¬ì¹˜êµ¬ì´', price: 7000}]},
    {id: 'p_honeymoon', name: 'í—ˆë‹ˆë¬¸í•˜ìš°ìŠ¤', type: 'cafe', region: 'south', lat: 33.2411, lng: 126.5325, cost: 25000, tags: ['ì˜¤ì…˜ë·°', 'ì •ì›'], menu: [{item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 8000}, {item: 'íŒŒì¸ì• í”Œ ì£¼ìŠ¤', price: 12000}, {item: 'ì¹˜ì¦ˆì¼€ì´í¬', price: 9000}]},
    {id: 'p_jungmunbyul', name: 'ì¤‘ë¬¸ë³„ì¥', type: 'cafe', region: 'south', lat: 33.2508, lng: 126.4208, cost: 22000, tags: ['ë¹ˆí‹°ì§€', 'ë””ì €íŠ¸'], menu: [{item: 'ë³„ì¥ì»¤í”¼', price: 7500, recommended: true}, {item: 'ë ˆëª¬ íŒŒìš´ë“œ', price: 7000}]},
    {id: 'p_lavarr', name: 'ë¼ë°”ë¥´', type: 'cafe', region: 'south', lat: 33.2461, lng: 126.4355, cost: 20000, tags: ['ì»¤í”¼', 'ë² ì´ì»¤ë¦¬'], menu: [{item: 'í”Œë«í™”ì´íŠ¸', price: 6500}, {item: 'í¬ë£¨ì•„ìƒ', price: 4500}]},
    {id: 'p_gojip_jungmun', name: 'ê³ ì§‘ëŒìš°ëŸ­ ì¤‘ë¬¸ì ', type: 'food', region: 'south', lat: 33.2515, lng: 126.4259, cost: 80000, tags: ['ê°ˆì¹˜', 'í–¥í† ìŒì‹'], menu: [{item: 'ëŸ°ì¹˜Aì„¸íŠ¸(1ì¸)', price: 31000, recommended: true}, {item: 'ê°ˆì¹˜ì¡°ë¦¼(ì†Œ)', price: 68000}, {item: 'ìš°ëŸ­ì¡°ë¦¼(ì†Œ)', price: 68000}]},
    {id: 'p_alssam', name: 'ì•ŒìŒˆë‹­', type: 'food', region: 'south', lat: 33.2467, lng: 126.5600, cost: 55000, tags: ['ë‹­ê°ˆë¹„', 'ì¹˜ì¦ˆ'], menu: [{item: 'ì•ŒìŒˆë‹­(2ì¸)', price: 28000}, {item: 'ì¹˜ì¦ˆ ë‹­ê°ˆë¹„(2ì¸)', price: 30000, recommended: true}]},
    
    // ì œì£¼ì‹œ
    {id: 'p_yongduam', name: 'ìš©ë‘ì•”', type: 'activity', region: 'city', lat: 33.5133, lng: 126.5113, cost: 0, tags: ['ë°”ìœ„', 'í•´ì•ˆë„ë¡œ', 'ê´€ê´‘ì§€'], menu: [{item: 'ì…ì¥ë£Œ', price: 0}]},
    {id: 'p_dongmun', name: 'ë™ë¬¸ì‹œì¥', type: 'food', region: 'city', lat: 33.5126, lng: 126.5292, cost: 40000, tags: ['ì•¼ì‹œì¥', 'í–¥í† ìŒì‹'], menu: [{item: 'ë”±ìƒˆìš°íšŒ', price: 20000, recommended: true}, {item: 'í‘ë¼ì§€ ê¹€ì¹˜ë§ì´', price: 8000}, {item: 'ì˜¤ë©”ê¸°ë–¡', price: 6000}]},
    {id: 'p_sistersnoodle', name: 'ìë§¤êµ­ìˆ˜', type: 'food', region: 'city', lat: 33.4879, lng: 126.5458, cost: 35000, tags: ['ê³ ê¸°êµ­ìˆ˜', 'í–¥í† ìŒì‹'], menu: [{item: 'ê³ ê¸°êµ­ìˆ˜', price: 9000, recommended: true}, {item: 'ë¹„ë¹”êµ­ìˆ˜', price: 9000}, {item: 'ë”ë² ê³ ê¸°(ì†Œ)', price: 15000}]},
    {id: 'p_jejukim', name: 'ì œì£¼ê¹€ë§Œë³µ', type: 'food', region: 'city', lat: 33.5111, lng: 126.5188, cost: 25000, tags: ['ê¹€ë°¥', 'ê³µí•­ê·¼ì²˜'], menu: [{item: 'ë§Œë³µì´ë„¤ê¹€ë°¥', price: 7500, recommended: true}, {item: 'ì˜¤ì§•ì–´ë¬´ì¹¨', price: 5500}, {item: 'í†µì „ë³µì£¼ë¨¹ë°¥', price: 6500}]},
    {id: 'p_myeongjin_city', name: 'ëª…ì§„ì „ë³µ(ì‹œë‚´ì )', type: 'food', region: 'city', lat: 33.4912, lng: 126.5057, cost: 60000, tags: ['ì „ë³µ', 'í–¥í† ìŒì‹'], menu: [{item: 'ì „ë³µ ëŒì†¥ë°¥', price: 16000, recommended: true}, {item: 'ì „ë³µì£½', price: 13000}, {item: 'ì „ë³µ êµ¬ì´', price: 30000}]},
    {id: 'p_gojip_airport', name: 'ê³ ì§‘ëŒìš°ëŸ­ ê³µí•­ì ', type: 'food', region: 'city', lat: 33.5042, lng: 126.5034, cost: 80000, tags: ['ê°ˆì¹˜', 'ê³µí•­ê·¼ì²˜', 'í–¥í† ìŒì‹'], menu: [{item: 'ëŸ°ì¹˜Aì„¸íŠ¸(1ì¸)', price: 31000, recommended: true}, {item: 'ê°ˆì¹˜ì¡°ë¦¼(ì†Œ)', price: 68000}, {item: 'ìš°ëŸ­ì¡°ë¦¼(ì†Œ)', price: 68000}]},
    {id: 'p_asalam', name: 'ì•„ì‚´ëŒ ë ˆìŠ¤í† ë‘', type: 'food', region: 'city', lat: 33.5011, lng: 126.5330, cost: 60000, tags: ['í• ë„', 'ì¸ë„ìŒì‹', 'ë ˆìŠ¤í† ë‘'], menu: [{item: 'ì¹˜í‚¨ ë§ˆí¬ë‹ˆ ì»¤ë¦¬', price: 15000, recommended: true}, {item: 'íƒ„ë‘ë¦¬ ì¹˜í‚¨', price: 20000}, {item: 'ê°ˆë¦­ ë‚œ', price: 3000}]},
    {id: 'p_jeonbok', name: 'ì „ë³µì‹ë‹¹', type: 'food', region: 'city', lat: 33.5140, lng: 126.5160, cost: 70000, tags: ['ì „ë³µ', 'í–¥í† ìŒì‹'], menu: [{item: 'ì „ë³µì½”ìŠ¤ìš”ë¦¬(1ì¸)', price: 50000, recommended: true}, {item: 'ì „ë³µëŒì†¥ë°¥', price: 15000}]},
    {id: 'p_songlim', name: 'ì†¡ë¦¼ì‹ë‹¹', type: 'food', region: 'city', lat: 33.5132, lng: 126.5225, cost: 45000, tags: ['í•´ì¥êµ­', 'í˜„ì§€ì¸ë§›ì§‘'], menu: [{item: 'ì†Œê³ ê¸°í•´ì¥êµ­', price: 9000, recommended: true}, {item: 'ë‚´ì¥íƒ•', price: 10000}]},
];


// --- ì—¬í–‰ ì¼ì • ë°ì´í„°: ê²€ìƒ‰ ê²°ê³¼ í™•ëŒ€ë¥¼ ìœ„í•´ radius ë° max ê°’ ìƒí–¥ ì¡°ì • ---
const itineraryData = {
    day1: {
        title: "ì œì£¼ ë„ì°© & ì„¤ë ˆëŠ” ì²«ë‚  ë°¤",
        slots: {
            '18:00': { icon: 'âœˆï¸', category: 'ê³µí•­ ë„ì°©', fixed: { id: 'arrival', name: 'ì œì£¼êµ­ì œê³µí•­', cost: 0, type: 'etc', lat: 33.5104, lng: 126.4913 } },
            '19:00': { icon: 'ğŸ¨', category: 'ìˆ™ì†Œ ì²´í¬ì¸', fixed: { id: 'checkin_hotel', name: 'ì²´í¬ì¸í˜¸í…” ì œì£¼', cost: 0, type: 'accommodation', lat: 33.5015, lng: 126.5050 } },
            '19:30': { icon: 'ğŸ´', category: 'ì €ë… ì‹ì‚¬', search: { type: 'food', keywords: ['í‘ë¼ì§€', 'ê³ ê¸°êµ­ìˆ˜', 'í•´ë¬¼íƒ•'], radius: 5000, max: 12 } },
            '21:00': { icon: 'â˜•', category: 'ì•¼ê°„ ì¹´í˜', search: { type: 'cafe', keywords: ['ì•¼ê²½ ì¹´í˜', 'ë””ì €íŠ¸'], radius: 7000, max: 8 } }
        }
    },
    day2: {
        title: "í™˜ìƒì˜ ë™ìª½ í•´ì•ˆë„ë¡œ ì¼ì£¼",
        slots: {
            '09:00': { icon: 'ğŸ³', category: 'ì•„ì¹¨ ì‹ì‚¬', search: { type: 'food', keywords: ['í•´ì¥êµ­', 'ì „ë³µì£½', 'ê¹€ë°¥'], radius: 15000, max: 12 }},
            '10:30': { icon: 'ğŸŸï¸', category: 'ì˜¤ì „ í™œë™', search: { type: 'activity', tags: ['ê´€ê´‘ì§€', 'ì²´í—˜'], max: 6 } }, // í™œë™ì€ DB ê¸°ì¤€
            '13:00': { icon: 'ğŸ´', category: 'ì ì‹¬ ì‹ì‚¬', search: { type: 'food', keywords: ['í•´ë¬¼ë¼ë©´', 'ê°ˆì¹˜ì¡°ë¦¼', 'ì „ë³µ'], radius: 10000, max: 12 } },
            '15:00': { icon: 'â˜•', category: 'ì˜¤í›„ ì¹´í˜', search: { type: 'cafe', keywords: ['ì˜¤ì…˜ë·° ì¹´í˜', 'ë² ì´ì»¤ë¦¬'], radius: 12000, max: 8 } },
            '18:30': { icon: 'ğŸ¨', category: 'ìˆ™ì†Œ ì²´í¬ì¸', fixed: { id: 'thefirst70', name: 'ë” í¼ìŠ¤íŠ¸ 70 í˜¸í…”', cost: 0, type: 'accommodation', lat: 33.2476, lng: 126.5615 } },
            '19:30': { icon: 'ğŸ¢', category: 'ì €ë… ì‹ì‚¬', search: { type: 'food', keywords: ['í‘ë¼ì§€', 'íšŸì§‘', 'ì‹œì¥'], radius: 4000, max: 12 } }
        }
    },
    day3: {
        title: "ì„œê·€í¬ ìì—°ê³¼ ì„œìª½ì˜ ë‚­ë§Œ",
        slots: {
            '09:30': { icon: 'ğŸŸï¸', category: 'ì˜¤ì „ í™œë™', search: { type: 'activity', tags: ['ê´€ê´‘ì§€', 'ì²´í—˜'], max: 6 } }, // í™œë™ì€ DB ê¸°ì¤€
            '12:30': { icon: 'ğŸ´', category: 'ì ì‹¬ ì‹ì‚¬', search: { type: 'food', keywords: ['ê°ˆì¹˜ì¡°ë¦¼', 'ì¤‘ì‹', 'í–¥í† ìŒì‹'], radius: 12000, max: 12 } },
            '14:30': { icon: 'ğŸŸï¸', category: 'ì˜¤í›„ í™œë™', search: { type: 'activity', tags: ['ê´€ê´‘ì§€', 'ì²´í—˜'], max: 6 } }, // í™œë™ì€ DB ê¸°ì¤€
            '17:00': { icon: 'ğŸ¨', category: 'ìˆ™ì†Œ ì²´í¬ì¸', fixed: { id: 'airbnb', name: 'íŒí¬í¬êµ¬ í”„ë¦¬ë¯¸ì—„ ìŠ¤í…Œì´', cost: 0, type: 'accommodation', lat: 33.3857, lng: 126.2104 } },
            '18:30': { icon: 'ğŸŒ…', category: 'ì €ë… ì‹ì‚¬', search: { type: 'food', keywords: ['í‘ë¼ì§€', 'ì˜¤ì…˜ë·° ë ˆìŠ¤í† ë‘'], radius: 8000, max: 12 } }
        }
    },
    day4: {
        title: "ì•„ì‰¬ìš´ ë§ˆì§€ë§‰ ë‚  & ì¶œë°œ",
        slots: {
            '10:00': { icon: 'â˜•', category: 'ë§ˆì§€ë§‰ ì¹´í˜', search: { type: 'cafe', keywords: ['ì• ì›” ì¹´í˜', 'ê³µí•­ê·¼ì²˜ ì¹´í˜'], radius: 15000, max: 8 } },
            '13:00': { icon: 'ğŸ´', category: 'ë§ˆì§€ë§‰ ì ì‹¬', search: { type: 'food', keywords: ['ê³µí•­ê·¼ì²˜ ë§›ì§‘', 'í•´ë¬¼ë¼ë©´'], radius: 8000, max: 12 } },
            '14:30': { icon: 'ğŸ', category: 'ê¸°ë…í’ˆ & ë°˜ë‚©', fixed: { id: 'shopping', name: 'ë ŒíŠ¸ì¹´ ë°˜ë‚© & ê³µí•­ ì´ë™', cost: 0, type: 'etc', lat: 33.5049, lng: 126.4950 }},
            '18:00': { icon: 'ğŸ›«', category: 'ì œì£¼ê³µí•­ ì¶œë°œ', fixed: { id: 'departure', name: 'ì—¬í–‰ ë§ˆë¬´ë¦¬', cost: 0, type: 'etc', lat: 33.5104, lng: 126.4913 } }
        }
    }
};

// --- ì „ì—­ ë³€ìˆ˜ ---
let googleMap, fullscreenMap, placesService, directionsService, directionsRenderer, infoWindow;
let activeDay = 1;
const selections = {};
let originalSelections = {};
let isNaviModeActive = false;
let watchId = null;
let userLocationMarker = null;
let fullscreenUserMarker = null;
let fullscreenMarkers = [];
const fixedCosts = { flight: 0, hotel: 0 };
const placeDetailsCache = {};

// --- ì´ˆê¸°í™” ë° UI ì„¤ì • í•¨ìˆ˜ ---
function initApp() {
    initUI();
    initMap();
    setupEventListeners();
}

function initUI() {
    const tabsContainer = document.getElementById('day-tabs-container');
    const itineraryContainer = document.getElementById('itinerary-container');
    tabsContainer.innerHTML = ''; 
    itineraryContainer.innerHTML = '';

    Object.keys(itineraryData).forEach((dayKey, index) => {
        const day = parseInt(dayKey.replace('day', ''));
        const tab = document.createElement('button');
        tab.className = `day-tab px-3 py-2 rounded-lg font-semibold transition text-sm ${index === 0 ? 'active' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`;
        tab.textContent = `${day}ì¼ì°¨`;
        tab.dataset.day = day;
        tabsContainer.appendChild(tab);
        
        const dayContent = document.createElement('div');
        dayContent.id = `day${day}`;
        dayContent.className = `day-content space-y-3 ${index > 0 ? 'hidden' : ''}`;
        dayContent.innerHTML = `<h2 class="text-xl font-bold text-gray-800">${itineraryData[dayKey].title}</h2>`;
        
        Object.entries(itineraryData[dayKey].slots).forEach(([time, slot]) => {
            dayContent.innerHTML += `<div class="compact-timeline relative"><div class="absolute left-0 top-1 h-full border-l-2 border-gray-300"></div><div class="timeline-dot absolute bg-blue-500 rounded-full border-2 border-white"></div><div class="bg-white rounded-lg shadow-md p-4"><div class="flex items-center mb-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold mr-3">${time}</span><h3 class="text-base font-bold text-gray-800">${slot.icon} ${slot.category}</h3><div class="distance-info" data-day="${day}" data-time="${time}"></div></div><div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-3" data-day="${day}" data-time="${time}"><div class="loading-container"><div class="spinner"></div><span class="text-xs mt-2">ì¶”ì²œ ì¥ì†Œ ê²€ìƒ‰ ì¤‘...</span></div></div></div></div>`;
        });
        itineraryContainer.appendChild(dayContent);
    });
    
    setupInitialState();
}

async function setupInitialState() {
    for (const dayKey of Object.keys(itineraryData)) {
        const day = parseInt(dayKey.replace('day', ''));
        selections[day] = {};
        let lastLocation = null;
        for (const [time, slot] of Object.entries(itineraryData[dayKey].slots)) {
            const grid = document.querySelector(`.options-grid[data-day="${day}"][data-time="${time}"]`);
            let options = await generateSlotOptions(slot, lastLocation);
            
            grid.innerHTML = generateOptionsHtml(day, time, options);

            const firstOptionKey = Object.keys(options)[0];
            if (firstOptionKey) {
                const optionData = options[firstOptionKey];
                selections[day][time] = { ...optionData };
                lastLocation = { lat: optionData.lat, lng: optionData.lng };
                const card = grid.querySelector(`.option-card`);
                if(card) card.classList.add('selected');
            }
        }
    }
    originalSelections = JSON.parse(JSON.stringify(selections));
    updateAllDisplays();
}

// [í•µì‹¬ ê°œì„ ] DBì™€ APIë¥¼ í†µí•©í•˜ì—¬ ì˜µì…˜ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
async function generateSlotOptions(slot, location) {
    if (slot.fixed) return { [slot.fixed.id]: slot.fixed };
    if (!slot.search) return {};

    const searchType = slot.search.type;
    const maxResults = slot.search.max || 6;

    // í™œë™/ê´€ê´‘ì§€ëŠ” ìì²´ DBì—ì„œë§Œ ê²€ìƒ‰
    if (searchType === 'activity') {
        let dbResults = allJejuPlaces.filter(p => p.type === 'activity' && (slot.search.tags || []).some(tag => p.tags.includes(tag)));
        if (location) {
            const startPoint = new google.maps.LatLng(location.lat, location.lng);
            dbResults.forEach(p => p.distance = google.maps.geometry.spherical.computeDistanceBetween(startPoint, new google.maps.LatLng(p.lat, p.lng)));
            dbResults.sort((a, b) => a.distance - b.distance);
        }
        const options = {};
        dbResults.slice(0, maxResults).forEach(p => options[p.id] = p);
        return options;
    }

    // ë§›ì§‘/ì¹´í˜ëŠ” DB + API í†µí•© ê²€ìƒ‰
    if (searchType === 'food' || searchType === 'cafe') {
        const dbPromise = (async () => {
            return allJejuPlaces.filter(p => p.type === searchType && (slot.search.keywords || []).some(kw => p.tags.some(tag => tag.includes(kw)) || p.name.includes(kw)));
        })();
        
        const apiPromise = new Promise((resolve) => {
            if (!placesService || !location) { resolve([]); return; }
            placesService.nearbySearch({
                location: new google.maps.LatLng(location.lat, location.lng), 
                radius: slot.search.radius, 
                keyword: slot.search.keywords.join(' OR '),
                type: searchType,
                language: 'ko'
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    resolve(results
                        .filter(p => p.rating && p.user_ratings_total && p.rating >= 4.0 && p.user_ratings_total >= 100 && p.business_status === 'OPERATIONAL')
                        .map(p => ({ 
                            id: p.place_id, 
                            name: p.name, 
                            cost: estimateDynamicCost(searchType), 
                            type: searchType, 
                            tags: [`â­ ${p.rating}`, `${p.user_ratings_total.toLocaleString()} ë¦¬ë·°`], 
                            lat: p.geometry.location.lat(), 
                            lng: p.geometry.location.lng() 
                        }))
                    );
                } else {
                    resolve([]);
                }
            });
        });

        const [dbResults, apiResults] = await Promise.all([dbPromise, apiPromise]);
        
        const uniquePlaces = new Map();
        dbResults.forEach(p => uniquePlaces.set(p.name, p));
        apiResults.forEach(p => {
            if (!uniquePlaces.has(p.name)) {
                uniquePlaces.set(p.name, p);
            }
        });

        const combinedResults = Array.from(uniquePlaces.values());

        if (location) {
            const startPoint = new google.maps.LatLng(location.lat, location.lng);
            combinedResults.forEach(p => {
                if (!p.distance) {
                    p.distance = google.maps.geometry.spherical.computeDistanceBetween(startPoint, new google.maps.LatLng(p.lat, p.lng));
                }
            });
            combinedResults.sort((a, b) => a.distance - b.distance);
        }

        const options = {};
        combinedResults.slice(0, maxResults).forEach(p => options[p.id] = p);
        return options;
    }

    return {};
}


function estimateDynamicCost(type) {
    if (type === 'food') return Math.floor(Math.random() * 4 + 6) * 10000;
    if (type === 'cafe') return Math.floor(Math.random() * 1.5 + 2) * 10000;
    return 0;
}

function initMap() {
    try {
        const jejuCenter = { lat: 33.385, lng: 126.55 };
        googleMap = new google.maps.Map(document.getElementById('map'), { center: jejuCenter, zoom: 9, styles: [{featureType: "poi",elementType: "labels",stylers: [{ visibility: "off" }]}] });
        fullscreenMap = new google.maps.Map(document.getElementById('fullscreen-map'), { center: jejuCenter, zoom: 10, styles: [{featureType: "poi",elementType: "labels",stylers: [{ visibility: "off" }]}] });
        placesService = new google.maps.places.PlacesService(googleMap);
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#4f46e5', strokeWeight: 4, strokeOpacity: 0.8 } });
        infoWindow = new google.maps.InfoWindow();
        directionsRenderer.setMap(googleMap);
        updateMapForDay(1);
    } catch (e) { document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 text-sm">ì§€ë„ ë¡œë”© ì‹¤íŒ¨</div>'; }
}

function setupEventListeners() {
    document.getElementById('day-tabs-container').addEventListener('click', e => { if (e.target.classList.contains('day-tab')) switchDay(parseInt(e.target.dataset.day)); });
    document.getElementById('itinerary-container').addEventListener('click', e => { const card = e.target.closest('.option-card'); if (card) { handleOptionSelect(parseInt(card.closest('.options-grid').dataset.day), card.closest('.options-grid').dataset.time, card); } });
    document.getElementById('theme-search-toggle').onclick = openThemeSearchModal;
    document.getElementById('reset-button').onclick = resetToOriginal;
    document.getElementById('navi-mode-toggle').onclick = toggleNaviMode;
    document.getElementById('close-fullscreen').onclick = closeFullscreenModal;
    document.getElementById('flight-cost').onchange = e => { fixedCosts.flight = parseInt(e.target.value) || 0; updateAllDisplays(); };
    document.getElementById('hotel-cost').onchange = e => { fixedCosts.hotel = parseInt(e.target.value) || 0; updateAllDisplays(); };
    
    document.getElementById('theme-search-button').addEventListener('click', renderFilteredResults);
    document.getElementById('theme-keyword-search').addEventListener('keyup', (e) => { if (e.key === 'Enter') renderFilteredResults(); });
    document.getElementById('theme-category-buttons').addEventListener('click', e => {
        if(e.target.tagName === 'BUTTON') {
            document.querySelectorAll('#theme-category-buttons button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            renderFilteredResults();
        }
    });

    // [ë³µì›] ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    document.getElementById('close-detail-modal').onclick = closeDetailModal;
    document.getElementById('modal-overlay').onclick = closeDetailModal;
}


// --- ì „ì²´í™”ë©´ ê²€ìƒ‰ ê¸°ëŠ¥ ---
function openThemeSearchModal() {
    document.getElementById('fullscreen-modal').classList.add('active');
    startThemeSearch();
}

function startThemeSearch() {
    fullscreenMap.setCenter({ lat: 33.385, lng: 126.55 });
    fullscreenMap.setZoom(9.5);
    clearFullscreenMarkers();
    renderFilteredResults();
}

async function renderFilteredResults() {
    const container = document.getElementById('search-results');
    container.innerHTML = `<div class="p-8"><div class="loading-container"><div class="spinner"></div><span>ì¥ì†Œ ê²€ìƒ‰ ì¤‘...</span></div></div>`;

    const keyword = document.getElementById('theme-keyword-search').value.toLowerCase();
    const activeCategoryBtn = document.querySelector('#theme-category-buttons .active');
    const category = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'all';
    
    // 1. ìì²´ DB ê²€ìƒ‰
    let dbResults = allJejuPlaces;
    if (category !== 'all') dbResults = dbResults.filter(p => p.type === category);
    if (keyword) dbResults = dbResults.filter(p => p.name.toLowerCase().includes(keyword) || p.tags.some(t => t.toLowerCase().includes(keyword)));

    // 2. Google API ê²€ìƒ‰ (ë§›ì§‘/ì¹´í˜ì¼ ê²½ìš° & í‚¤ì›Œë“œ ìˆì„ ê²½ìš°)
    let apiResults = [];
    if ((category === 'food' || category === 'cafe' || category === 'all') && keyword) {
        apiResults = await new Promise(resolve => {
            placesService.textSearch({
                query: `ì œì£¼ ${keyword} ${category === 'food' ? 'ë§›ì§‘' : ''} ${category === 'cafe' ? 'ì¹´í˜' : ''}`,
                language: 'ko',
            }, (results, status) => {
                 if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    resolve(results
                        .filter(p => p.rating && p.user_ratings_total && p.rating >= 4.0 && p.user_ratings_total >= 100 && p.business_status === 'OPERATIONAL')
                        .map(p => ({ 
                            id: p.place_id, 
                            name: p.name, 
                            cost: estimateDynamicCost(p.types.includes('cafe') ? 'cafe' : 'food'), 
                            type: p.types.includes('cafe') ? 'cafe' : 'food', 
                            tags: [`â­ ${p.rating}`, `${p.user_ratings_total.toLocaleString()} ë¦¬ë·°`, p.formatted_address], 
                            lat: p.geometry.location.lat(), 
                            lng: p.geometry.location.lng() 
                        }))
                    );
                } else {
                    resolve([]);
                }
            });
        });
    }

    // 3. ê²°ê³¼ í†µí•©
    const uniquePlaces = new Map();
    dbResults.forEach(p => uniquePlaces.set(p.name, p));
    apiResults.forEach(p => {
        if (!uniquePlaces.has(p.name)) uniquePlaces.set(p.name, p);
    });
    
    const combinedResults = Array.from(uniquePlaces.values());
    displaySearchResults(combinedResults);
    createFullscreenMarkers(combinedResults);
}

function displaySearchResults(results) {
    const container = document.getElementById('search-results');
    if (results.length === 0) { container.innerHTML = `<div class="p-8 text-center text-gray-500">ì¡°ê±´ì— ë§ëŠ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    
    const centerPoint = new google.maps.LatLng(33.4996, 126.5312);
    results.forEach(place => {
        if(place.lat && place.lng) place.distance = google.maps.geometry.spherical.computeDistanceBetween(centerPoint, new google.maps.LatLng(place.lat, place.lng)) / 1000;
        else place.distance = Infinity;
    });
    results.sort((a,b) => a.distance - b.distance);

    container.innerHTML = results.map(place => generatePlaceCardHtml(place)).join('');
    container.querySelectorAll('.place-card').forEach(card => {
        card.addEventListener('click', () => {
             const place = results.find(p => p.id === card.dataset.placeId);
             if(place) showDetailModal(place); // ìƒì„¸ ëª¨ë‹¬ ë„ìš°ê¸°
        });
    });
}

function generatePlaceCardHtml(place) {
    const typeMap = { 'food': 'ë§›ì§‘', 'cafe': 'ì¹´í˜', 'activity': 'ê´€ê´‘/ì²´í—˜', 'etc': 'ê¸°íƒ€' };
    const iconMap = { 'food': 'ğŸ½ï¸', 'cafe': 'â˜•', 'activity': 'ğŸŸï¸', 'etc': 'ğŸ“' };
    return `<div class="place-card" data-place-id="${place.id}"><div class="flex justify-between items-start"><h3 class="font-bold text-base pr-2">${iconMap[place.type] || 'ğŸ“'} ${place.name}</h3>${place.distance !== Infinity ? `<span class="text-sm font-bold text-blue-600">${place.distance.toFixed(1)}km</span>` : ''}</div><div class="flex items-center text-sm text-gray-600 mt-1"><p class="text-xs text-gray-500">${(place.tags || []).slice(0, 3).join(', ')}</p><span class="ml-auto text-xs bg-gray-200 px-2 py-1 rounded-full">${typeMap[place.type]}</span></div></div>`;
}

function createFullscreenMarkers(places) {
    clearFullscreenMarkers(false);
    const bounds = new google.maps.LatLngBounds();
    const iconMap = { 'food': 'https://maps.google.com/mapfiles/ms/icons/restaurant.png', 'cafe': 'https://maps.google.com/mapfiles/ms/icons/coffeehouse.png', 'activity': 'https://maps.google.com/mapfiles/ms/icons/flag.png' };
    places.forEach(place => {
        if (!place.lat || !place.lng) return;
        const marker = new google.maps.Marker({
            position: {lat: place.lat, lng: place.lng}, map: fullscreenMap, title: place.name,
            icon: { url: iconMap[place.type] || 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', scaledSize: new google.maps.Size(32, 32) }
        });
        marker.addListener('click', () => { showDetailModal(place); }); // ë§ˆì»¤ í´ë¦­ ì‹œ ëª¨ë‹¬ ë„ìš°ê¸°
        fullscreenMarkers.push(marker);
        bounds.extend({lat: place.lat, lng: place.lng});
    });
    if (places.length > 0 && !bounds.isEmpty()) { 
        fullscreenMap.fitBounds(bounds); 
        if (fullscreenMap.getZoom() > 15) fullscreenMap.setZoom(15);
    }
}

// --- [ë³µì›] ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---
function showDetailModal(placeData) {
    selectPlaceOnMap(placeData); // ì§€ë„ë¥¼ ë¨¼ì € ì´ë™ì‹œí‚´

    const modal = document.getElementById('place-detail-modal'), overlay = document.getElementById('modal-overlay');
    document.getElementById('place-name').textContent = placeData.name;
    const detailsContainer = document.getElementById('place-details');
    detailsContainer.innerHTML = `<div class="loading-container"><div class="spinner"></div><span>ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...</span></div>`;
    modal.classList.add('active'); overlay.classList.add('active');
    
    const cacheKey = placeData.id;
    if (placeDetailsCache[cacheKey] && placeDetailsCache[cacheKey].reviews) {
        displayDetailModalContent(placeDetailsCache[cacheKey]);
        return;
    }
    
    const placeIdToSearch = placeData.id.startsWith('p_') ? null : placeData.id;

    const getDetailsCallback = (detail, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && detail) {
            placeDetailsCache[cacheKey] = detail;
            displayDetailModalContent(detail);
        } else {
             detailsContainer.innerHTML = '<div class="text-center text-gray-500 py-4">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    };
    
    if(placeIdToSearch) {
         placesService.getDetails({ placeId: placeIdToSearch, fields: ['name', 'formatted_address', 'formatted_phone_number', 'website', 'rating', 'user_ratings_total', 'reviews', 'photos', 'types', 'url'], language: 'ko' }, getDetailsCallback);
    } else {
        placesService.findPlaceFromQuery({ query: placeData.name, locationBias: { lat: placeData.lat, lng: placeData.lng }, fields: ['place_id'] }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
                 placesService.getDetails({ placeId: results[0].place_id, fields: ['name', 'formatted_address', 'formatted_phone_number', 'website', 'rating', 'user_ratings_total', 'reviews', 'photos', 'types', 'url'], language: 'ko' }, getDetailsCallback);
            } else { getDetailsCallback(null, status); }
        });
    }
}

function displayDetailModalContent(place) {
    let html = `<div class="space-y-4"><div class="border-b pb-4"><div class="flex items-center justify-between mb-2"><div class="flex items-center"><span class="text-yellow-500 mr-1">â­</span><span class="font-bold">${place.rating||'N/A'}</span><span class="text-gray-500 ml-2">(${(place.user_ratings_total||0).toLocaleString()} ë¦¬ë·°)</span></div></div><p class="text-sm text-gray-600 mb-2">${place.formatted_address||''}</p>${place.formatted_phone_number?`<p class="text-sm text-blue-600">ğŸ“ ${place.formatted_phone_number}</p>`:''}${place.website?`<a href="${place.website}" target="_blank" class="text-sm text-blue-600 hover:underline">ğŸŒ ì›¹ì‚¬ì´íŠ¸</a>`:''}</div>`;
    if (place.types) html += `<div class="border-b pb-4"><h4 class="font-bold mb-2">ğŸ“‹ ì¹´í…Œê³ ë¦¬</h4><div class="flex flex-wrap gap-2">${place.types.map(t=>`<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${t}</span>`).join('')}</div></div>`;
    if (place.photos) html += `<div class="border-b pb-4"><h4 class="font-bold mb-2">ğŸ“¸ ì‚¬ì§„</h4><div class="grid grid-cols-2 gap-2">${place.photos.slice(0,4).map(p=>`<img src="${p.getUrl({maxWidth:200,maxHeight:150})}" class="w-full h-24 object-cover rounded-lg" onclick="window.open('${p.getUrl()}','_blank')">`).join('')}</div></div>`;
    if (place.reviews) html += `<div class="border-b pb-4"><h4 class="font-bold mb-2">ğŸ’¬ ìµœê·¼ ë¦¬ë·°</h4><div class="space-y-3 max-h-64 overflow-y-auto pr-2">${place.reviews.slice(0,10).map(r=>`<div class="bg-gray-50 p-3 rounded-lg"><div class="flex items-center justify-between mb-2"><div class="flex items-center"><span class="font-semibold text-sm">${r.author_name}</span><span class="ml-2 text-yellow-500">${'â­'.repeat(r.rating)}</span></div><span class="text-xs text-gray-500">${r.relative_time_description}</span></div><p class="text-sm text-gray-700">${r.text}</p></div>`).join('')}</div></div>`;
    html += `<div class="flex space-x-2"><a href="${place.url}" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm"><i class="fab fa-google mr-2"></i>êµ¬ê¸€ë§µì—ì„œ ë³´ê¸°</a><button onclick="alert('ì¼ì • ì¶”ê°€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition text-sm"><i class="fas fa-plus mr-2"></i>ì¼ì •ì— ì¶”ê°€</button></div>`;
    document.getElementById('place-details').innerHTML = html + `</div>`;
}

function closeDetailModal() {
    document.getElementById('place-detail-modal').classList.remove('active'); document.getElementById('modal-overlay').classList.remove('active');
}
// --- ë‚˜ë¨¸ì§€ ì½”ë“œ (ì´ì „ ë‹µë³€ê³¼ ë™ì¼) ---
function selectPlaceOnMap(place) { fullscreenMap.panTo({lat: place.lat, lng: place.lng}); fullscreenMap.setZoom(15); }
function clearFullscreenMarkers(includeUserMarker = true) { fullscreenMarkers.forEach(marker => marker.setMap(null)); fullscreenMarkers = []; if (includeUserMarker && fullscreenUserMarker) { fullscreenUserMarker.setMap(null); fullscreenUserMarker = null; } }
function closeFullscreenModal() { document.getElementById('fullscreen-modal').classList.remove('active'); clearFullscreenMarkers(); }
async function handleOptionSelect(day, time, cardElement) {
    const grid = cardElement.parentElement;
    const isAlreadySelected = cardElement.classList.contains('selected');
    const existingDetailsPanel = grid.querySelector('.details-panel');
    if (existingDetailsPanel) { existingDetailsPanel.remove(); }
    grid.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
    if (isAlreadySelected) { delete selections[day][time]; updateAllDisplays(); return; }
    cardElement.classList.add('selected');
    const optionData = { id: cardElement.dataset.id, name: cardElement.dataset.name, cost: parseInt(cardElement.dataset.cost), type: cardElement.dataset.type, lat: parseFloat(cardElement.dataset.lat), lng: parseFloat(cardElement.dataset.lng), menu: JSON.parse(cardElement.dataset.menu || 'null') };
    selections[day][time] = optionData;
    showDetailsPanel(cardElement, optionData);
    const allTimes = Object.keys(itineraryData[`day${day}`].slots);
    const currentIndex = allTimes.indexOf(time);
    if (currentIndex < allTimes.length - 1) {
        const nextTime = allTimes[currentIndex + 1];
        const nextSlot = itineraryData[`day${day}`].slots[nextTime];
        const nextGrid = document.querySelector(`.options-grid[data-day="${day}"][data-time="${nextTime}"]`);
        if (nextSlot && (nextSlot.search || nextSlot.fixed)) {
            delete selections[day][nextTime];
            nextGrid.innerHTML = `<div class="loading-container"><div class="spinner"></div><span class="text-xs mt-2">ë‹¤ìŒ ì¶”ì²œ ì¥ì†Œ ê²€ìƒ‰ ì¤‘...</span></div>`;
            setTimeout(async () => {
                const currentLoc = { lat: optionData.lat, lng: optionData.lng };
                const newOptions = await generateSlotOptions(nextSlot, currentLoc);
                nextGrid.innerHTML = generateOptionsHtml(day, nextTime, newOptions);
                const firstNewOptionKey = Object.keys(newOptions)[0];
                if (firstNewOptionKey) {
                    const firstCard = nextGrid.querySelector('.option-card');
                    if(firstCard) {
                        firstCard.classList.add('selected');
                        selections[day][nextTime] = newOptions[firstNewOptionKey];
                    }
                }
                updateAllDisplays();
            }, 200);
        }
    }
    updateAllDisplays();
}
function showDetailsPanel(cardElement, optionData) {
    const detailsPanel = document.createElement('div');
    detailsPanel.className = 'details-panel col-span-1 md:col-span-2 bg-gray-50 p-3 rounded-lg border';
    cardElement.insertAdjacentElement('afterend', detailsPanel);
    detailsPanel.innerHTML = `<div class="details-section" data-content="menu"><h4 class="text-sm font-bold mb-2 border-b pb-1">ğŸ“‹ ëŒ€í‘œ ë©”ë‰´/ê°€ê²©</h4><div class="menu-content-area"></div></div><div class="details-section" data-content="reviews"><h4 class="text-sm font-bold mb-2 border-b pb-1">ğŸ’¬ ì‹¤ì‹œê°„ ë¦¬ë·°/ì •ë³´</h4><div class="review-content-area"></div></div>`;
    const menuContainer = detailsPanel.querySelector('.menu-content-area');
    if (optionData.menu && optionData.menu.length > 0) { menuContainer.innerHTML = generateMenuHtml(optionData.menu); } else { menuContainer.innerHTML = '<p class="text-center text-xs text-gray-500 py-2">ë©”ë‰´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; }
    fetchLiveReviews(detailsPanel.querySelector('.review-content-area'), optionData);
    requestAnimationFrame(() => { detailsPanel.classList.add('open'); detailsPanel.style.height = 'auto'; detailsPanel.style.height = detailsPanel.scrollHeight + 'px'; });
}
function generateMenuHtml(menu) { const recommended = menu.filter(item => item.recommended); const normal = menu.filter(item => !item.recommended); const sortedMenu = [...normal, ...recommended]; let html = sortedMenu.map(item => `<div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-200 last:border-b-0"><span class="text-gray-700">${item.recommended ? 'â­ ' : ''}${item.item}</span><span class="font-semibold">â‚©${item.price.toLocaleString()}</span></div>`).join(''); if(recommended.length > 0) { html += '<p class="text-right text-xs mt-2 text-blue-600">â­ ì¶”ì²œ ë©”ë‰´</p>';} return html; }
function fetchLiveReviews(container, optionData) {
    container.innerHTML = `<div class="loading-container" style="min-height: 100px;"><div class="spinner"></div></div>`;
    const cacheKey = optionData.id;
    if (placeDetailsCache[cacheKey] && placeDetailsCache[cacheKey].reviews) { displayReviewContent(container, placeDetailsCache[cacheKey]); return; }
    const getDetailsCallback = (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place) { placeDetailsCache[cacheKey] = place; displayReviewContent(container, place); } else { container.innerHTML = '<p class="text-center text-xs text-gray-500 py-2">ì¥ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; }
        const panel = container.closest('.details-panel'); if (panel && panel.classList.contains('open')) { panel.style.height = 'auto'; panel.style.height = panel.scrollHeight + 'px'; }
    };
    const placeIdToSearch = optionData.id.startsWith('p_') ? null : optionData.id;
    if (placeIdToSearch) { placesService.getDetails({ placeId: placeIdToSearch, fields: ['rating', 'user_ratings_total', 'reviews', 'url', 'name'], language: 'ko' }, getDetailsCallback); } else { placesService.findPlaceFromQuery({ query: optionData.name, locationBias: { lat: optionData.lat, lng: optionData.lng }, fields: ['place_id'] }, (results, status) => { if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) { placesService.getDetails({ placeId: results[0].place_id, fields: ['rating', 'user_ratings_total', 'reviews', 'url', 'name'], language: 'ko' }, getDetailsCallback); } else { getDetailsCallback(null, status); } }); }
}
function displayReviewContent(container, place) {
    let reviewHtml = '<p class="text-center text-xs text-gray-500 py-2">ë¦¬ë·° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    if (place && place.reviews) { reviewHtml = place.reviews.slice(0, 3).map(review => `<div class="bg-gray-100 p-2 rounded-md mb-2"><p class="text-xs text-gray-700">${review.text.substring(0, 80)}...</p><div class="text-right text-xs mt-1 text-gray-500">${'â­'.repeat(review.rating)} by ${review.author_name} (${review.relative_time_description})</div></div>`).join(''); }
    container.innerHTML = `<div class="space-y-2"><div class="flex items-center justify-between text-xs"><span class="font-semibold">í‰ì : â­ ${place.rating || 'N/A'}/5.0</span><span class="text-gray-500">(${(place.user_ratings_total || 0).toLocaleString()} ë¦¬ë·°)</span></div>${reviewHtml}${place.url ? `<a href="${place.url}" target="_blank" onclick="event.stopPropagation()" class="block w-full text-center mt-2 bg-gray-200 text-gray-700 font-semibold py-1 rounded text-xs hover:bg-gray-300 transition"><i class="fab fa-google mr-1"></i>êµ¬ê¸€ë§µì—ì„œ ë” ë³´ê¸°</a>` : ''}</div>`;
}
function generateOptionsHtml(day, time, options) {
    let html = '';
    if (Object.keys(options).length === 0) { return `<div class="col-span-1 md:col-span-2 text-center text-sm text-gray-500 py-4">ì¶”ì²œ ì¥ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ ì¥ì†Œë¥¼ ì„ íƒí•´ ë³´ì„¸ìš”.</div>`; }
    Object.entries(options).forEach(([id, opt]) => { const typeIcon = opt.type === 'food' ? 'ğŸ´' : (opt.type === 'cafe' ? 'â˜•' : 'ğŸŸï¸'); html += `<div class="option-card border-gray-200 rounded-lg p-3 cursor-pointer" data-id="${opt.id}" data-name="${opt.name.replace(/"/g, '"')}" data-cost="${opt.cost || 0}" data-type="${opt.type}" data-lat="${opt.lat}" data-lng="${opt.lng}" data-menu='${JSON.stringify(opt.menu || null)}'><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-gray-800 text-sm pr-2">${typeIcon} ${opt.name}</h4>${opt.cost > 0 ? `<span class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded-full whitespace-nowrap">â‚©${(opt.cost || 0).toLocaleString()}</span>` : ''}</div><div class="flex flex-wrap gap-1 mt-2">${(opt.tags || []).slice(0, 3).map(tag => `<span class="text-xs font-semibold ${tag.startsWith('â­') ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-700'} px-2 py-1 rounded-full">${tag}</span>`).join('')}</div></div>`; }); return html;
}
function switchDay(day) { activeDay = day; document.querySelectorAll('.day-tab').forEach(tab => { tab.classList.toggle('active', parseInt(tab.dataset.day) === day); tab.classList.toggle('bg-gray-200', parseInt(tab.dataset.day) !== day); tab.classList.toggle('text-gray-600', parseInt(tab.dataset.day) !== day); }); document.querySelectorAll('.day-content').forEach(content => { content.classList.toggle('hidden', parseInt(content.id.replace('day', '')) !== day); }); updateAllDisplays(); }
function resetToOriginal() { if (confirm('ì›ë˜ ê³„íšëœ ì¼ì •ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) { selections = JSON.parse(JSON.stringify(originalSelections)); initUI(); } }
function updateAllDisplays() { updateCostDisplay(); updateSelectedItemsDisplay(); updateMapForDay(activeDay); }
function updateCostDisplay() { const costs = { food: 0, activity: 0, etc: 0 }; Object.values(selections).flat().forEach(sel => { if (!sel || sel.type === 'accommodation' || !sel.cost) return; if (sel.type === 'food' || sel.type === 'cafe') costs.food += sel.cost; else if (sel.type === 'activity') costs.activity += sel.cost; else costs.etc += sel.cost; }); document.getElementById('cost-food').textContent = `â‚©${costs.food.toLocaleString()}`; document.getElementById('cost-activity').textContent = `â‚©${costs.activity.toLocaleString()}`; document.getElementById('cost-etc').textContent = `â‚©${costs.etc.toLocaleString()}`; const total = Object.values(costs).reduce((a, b) => a + b, 0) + fixedCosts.flight + fixedCosts.hotel; document.getElementById('total-cost').textContent = `â‚©${total.toLocaleString()}`; }
function updateSelectedItemsDisplay() { const container = document.getElementById('selected-items-container'); container.innerHTML = ''; const daySelections = selections[activeDay] || {}; const sortedTimes = Object.keys(daySelections).sort(); if(Object.keys(daySelections).length === 0) { container.innerHTML = '<p class="text-center text-gray-500 py-3 text-xs">ì„ íƒëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } const list = document.createElement('div'); list.className = 'space-y-2 text-xs'; sortedTimes.forEach(time => { const sel = daySelections[time]; if (sel && sel.type !== 'accommodation') { list.innerHTML += `<div class="flex items-center"><span class="font-semibold text-blue-600 w-12">${time}</span><span class="flex-grow text-gray-700">${sel.name}</span>${sel.cost > 0 ? `<span class="font-semibold text-gray-800 text-right">â‚©${sel.cost.toLocaleString()}</span>` : ''}</div>`; } }); container.appendChild(list); }
function updateMapForDay(day) { if (!googleMap || !directionsRenderer) return; const daySelections = Object.values(selections[day] || {}).filter(s => s && s.lat && s.lng); daySelections.sort((a,b) => { const tA = Object.keys(selections[day]).find(k=>selections[day][k]&&selections[day][k].id===a.id), tB = Object.keys(selections[day]).find(k=>selections[day][k]&&selections[day][k].id===b.id); if(!tA||!tB) return 0; return tA.localeCompare(tB); }); if (window.dayMarkers) window.dayMarkers.forEach(m => m.setMap(null)); window.dayMarkers = []; infoWindow.close(); directionsRenderer.setDirections({routes: []}); if(daySelections.length === 0) { googleMap.setCenter({ lat: 33.385, lng: 126.55 }); googleMap.setZoom(9); return; }; const bounds = new google.maps.LatLngBounds(); daySelections.forEach((sel, index) => { const pos = { lat: sel.lat, lng: sel.lng }; bounds.extend(pos); const marker = new google.maps.Marker({ position: pos, map: googleMap, label: { text: `${index + 1}`, color: 'white', fontWeight: 'bold' }, title: sel.name }); marker.addListener('click', () => { infoWindow.setContent(`<div class="font-bold p-1">${sel.name}</div>`); infoWindow.open(googleMap, marker); }); window.dayMarkers.push(marker); }); if (daySelections.length > 1) { const request = { origin: { lat: daySelections[0].lat, lng: daySelections[0].lng }, destination: { lat: daySelections[daySelections.length-1].lat, lng: daySelections[daySelections.length-1].lng }, waypoints: daySelections.slice(1, -1).map(s => ({ location: { lat: s.lat, lng: s.lng } })), travelMode: 'DRIVING' }; directionsService.route(request, (result, status) => { if (status === 'OK') directionsRenderer.setDirections(result); }); } if (userLocationMarker) bounds.extend(userLocationMarker.getPosition()); googleMap.fitBounds(bounds); if(daySelections.length === 1 && !userLocationMarker) googleMap.setZoom(14); }
function toggleNaviMode() { const btn = document.getElementById('navi-mode-toggle'); isNaviModeActive = !isNaviModeActive; btn.classList.toggle('active', isNaviModeActive); if (isNaviModeActive) { if (navigator.geolocation) { btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>GPS ì—°ê²° ì¤‘...`; watchId = navigator.geolocation.watchPosition(handleLocationUpdate, handleLocationError, { enableHighAccuracy: true }); } else { alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); isNaviModeActive = false; btn.classList.remove('active'); } } else { if (watchId !== null) navigator.geolocation.clearWatch(watchId); watchId = null; if (userLocationMarker) userLocationMarker.setMap(null); userLocationMarker = null; btn.innerHTML = `<i class="fas fa-location-arrow mr-2"></i>Live GPS`; document.querySelectorAll('.distance-info').forEach(el => el.innerHTML = ''); } }
function handleLocationUpdate(position) { const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude }; document.getElementById('navi-mode-toggle').innerHTML = `<i class="fas fa-location-arrow mr-2"></i>GPS ì—°ê²°ë¨`; if (!userLocationMarker) { userLocationMarker = new google.maps.Marker({ position: userLocation, map: googleMap, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 }, title: "í˜„ì¬ ë‚´ ìœ„ì¹˜" }); } else { userLocationMarker.setPosition(userLocation); } updateDistances(userLocation); }
function handleLocationError(error) { alert(`ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`); const btn = document.getElementById('navi-mode-toggle'); isNaviModeActive = false; btn.classList.remove('active'); btn.innerHTML = `<i class="fas fa-location-arrow mr-2"></i>Live GPS`; }
function updateDistances(userLocation) { const daySels = selections[activeDay] || {}; const sortedTimes = Object.keys(daySels).sort(); const now = new Date(); const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; const nextTime = sortedTimes.find(time => time > currentTimeStr); document.querySelectorAll('.distance-info').forEach(el => el.innerHTML = ''); if (nextTime) { const nextDest = daySels[nextTime]; if (nextDest && nextDest.lat) { directionsService.route({ origin: userLocation, destination: { lat: nextDest.lat, lng: nextDest.lng }, travelMode: 'DRIVING' }, (result, status) => { if (status === 'OK') { const leg = result.routes[0].legs[0]; const distEl = document.querySelector(`.distance-info[data-day="${activeDay}"][data-time="${nextTime}"]`); if (distEl) distEl.innerHTML = `ğŸ“ ë‹¤ìŒ ëª©ì ì§€ê¹Œì§€ ${leg.distance.text}, ${leg.duration.text}`; } }); } } }
function openInGoogleMaps() { const daySels = Object.values(selections[activeDay] || {}).filter(s => s && s.lat); daySels.sort((a,b) => { const tA = Object.keys(selections[activeDay]).find(k=>selections[activeDay][k].id===a.id), tB = Object.keys(selections[activeDay]).find(k=>selections[activeDay][k].id===b.id); if(!tA || !tB) return 0; return tA.localeCompare(tB); }); if(daySels.length < 1) { alert("ë¨¼ì € ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; } let url = 'https://www.google.com/maps/dir/'; if (userLocationMarker) { const pos = userLocationMarker.getPosition(); url += `${pos.lat()},${pos.lng()}/`; } daySels.forEach(sel => { url += `${sel.name.replace(/\s/g, '+')},+ì œì£¼/@${sel.lat},${sel.lng}/`; }); window.open(url, '_blank'); }
window.addEventListener('load', () => { if (typeof google === 'undefined') { console.log('Google Maps API not loaded, retrying...'); setTimeout(initApp, 1000); } });
</script>
</body>
</html>
