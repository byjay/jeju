<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê°•ê·€ì„ ë‹˜ì„ ìœ„í•œ ì œì£¼ì—¬í–‰ í”Œë˜ë„ˆ - by bong</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ì¤‘ìš”: geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOAEMIvJc9VndXLYgmUnWoAuXjlOYzDtg&callback=initApp&libraries=places,directions,geometry&v=weekly" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Noto Sans KR', sans-serif; }
        
        :root {
            --primary-blue: #3b82f6;
            --primary-purple: #7c3aed;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” ë ˆì´ì•„ì›ƒ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* í—¤ë”, ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë“± */
        .header-gradient { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-purple) 100%); color: white; padding: 1.5rem 1rem; text-align: center; flex-shrink: 0; }
        .control-panel-wrapper { padding: 0.5rem 1rem; background: white; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
        .day-tabs-container { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .day-tabs-container::-webkit-scrollbar { display: none; }
        .day-tab { transition: all 0.3s ease; border-radius: 12px; padding: 0.5rem 1rem; font-weight: 600; margin: 0.25rem; white-space: nowrap; flex-shrink: 0; }
        .day-tab.active { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-purple) 100%); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .day-tab:not(.active) { background: #f3f4f6; color: #1f2937; }
        
        /* ìŠ¤í‹°í‚¤ ì§€ë„ */
        #map-container { position: sticky; top: 0; z-index: 10; background: #e5e7eb; padding: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); flex-shrink: 0; }
        #map { height: 30vh; min-height: 200px; border-radius: 12px; width: 100%; }
        
        /* ë©”ì¸ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        .main-content-scroll { flex-grow: 1; overflow-y: auto; padding: 1rem; }

        .option-card { transition: all 0.3s ease; border: 2px solid #e5e7eb; border-radius: 12px; padding: 0.75rem; cursor: pointer; background: white; position: relative; }
        .option-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-color: var(--primary-blue); }
        .option-card.selected { border-color: var(--primary-blue); background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        
        /* ì‹¤ì‹œê°„ ì •ë³´ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .distance-info { background: rgba(16, 185, 129, 0.1); color: var(--success-green); padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .loading-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ë‹¤ìŒ ëª©ì ì§€ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .live-next-item {
            border-radius: 12px;
            box-shadow: 0 0 0 3px var(--warning-orange);
            background-color: #fffbeb;
        }
        .next-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: var(--warning-orange);
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .timeline-container { position: relative; padding-left: 2rem; }
        .timeline-line { position: absolute; left: 1rem; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary-blue) 0%, var(--primary-purple) 100%); }
        .timeline-dot { position: absolute; left: -8px; top: 1.5rem; width: 20px; height: 20px; background: var(--primary-blue); border: 4px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2; }
        .menu-panel { background: #f8fafc; border-radius: 12px; padding: 1rem; margin-top: 0.75rem; border: 1px solid #e2e8f0; max-height: 0; overflow: hidden; transition: all 0.4s ease; opacity: 0; }
        .menu-panel.open { max-height: 500px; opacity: 1; }
        .menu-tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 1rem; }
        .menu-tab { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; font-weight: 500; }
        .menu-tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: rgba(59, 130, 246, 0.1); }
        .menu-content { display: none; }
        .menu-content.active { display: block; }
        
        .collapsible-card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 1rem; overflow: hidden; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #1f2937 0%, #374151 100%); color: white; padding: 1rem; font-weight: 600; cursor: pointer; }
        .collapsible-header .toggle-icon { transition: transform 0.3s ease; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.open { max-height: 1000px; padding: 1rem; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- í—¤ë” -->
        <header class="header-gradient">
            <h1 class="text-2xl md:text-3xl font-bold mb-1">ğŸï¸ ê°•ê·€ì„ ë‹˜ ì œì£¼ì—¬í–‰ í”Œë˜ë„ˆ</h1>
            <p class="text-sm md:text-base opacity-90">ì‹¤ì‹œê°„ GPS â€¢ í’ë¶€í•œ ë°ì´í„° â€¢ ì™„ë²½í•œ ë™ì„  ê´€ë¦¬</p>
        </header>

        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="control-panel-wrapper">
            <div id="day-tabs-container" class="day-tabs-container">
                <!-- íƒ­ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ìŠ¤í‹°í‚¤ ì§€ë„ -->
        <div id="map-container">
            <div id="map"></div>
            <button onclick="openInGoogleMaps()" class="w-full mt-3 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition font-semibold text-sm">
                <i class="fas fa-directions mr-2"></i>êµ¬ê¸€ë§µì—ì„œ ê¸¸ì°¾ê¸°
            </button>
        </div>

        <!-- ë©”ì¸ ìŠ¤í¬ë¡¤ ì˜ì—­ -->
        <main class="main-content-scroll">
            <div class="flex flex-wrap gap-2 mb-4">
                 <button id="theme-search-toggle" class="text-sm flex-grow bg-gray-200 text-gray-800 py-2 px-3 rounded-lg font-semibold"><i class="fas fa-search mr-1"></i>í…Œë§ˆ ê²€ìƒ‰</button>
                 <button id="reset-button" class="text-sm flex-grow bg-gray-200 text-gray-800 py-2 px-3 rounded-lg font-semibold"><i class="fas fa-undo mr-1"></i>ë¦¬ì…‹</button>
                 <button id="navi-mode-toggle" class="text-sm flex-grow bg-blue-100 text-blue-800 py-2 px-3 rounded-lg font-bold"><i class="fas fa-location-arrow mr-1"></i>Live GPS ì¼œê¸°</button>
            </div>
            
            <div id="theme-search-panel" class="theme-search-panel hidden">
                <!-- í…Œë§ˆ ê²€ìƒ‰ ì»¨í…ì¸ ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <div id="itinerary-container" class="space-y-6 mb-6">
                <!-- ì¼ì •ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="sidebar-content-wrapper">
                <!-- ... ê¸°íƒ€ Collapsible ì¹´ë“œë“¤ (ì„ íƒëœ ì¼ì •, ê²½ë¹„ ê³„ì‚° ë“±) ... -->
            </div>

        </main>
    </div>

<script>
// ì œì£¼ë„ ì™„ì „ ë°ì´í„°ë² ì´ìŠ¤
const jejuDatabase = {
    restaurants: {
        dongmun_market: {
            id: 'dongmun_market', name: 'ë™ë¬¸ì‹œì¥', rating: 4.2, reviewCount: 2847, cost: 30000, type: 'food',
            lat: 33.5126, lng: 126.5292, tags: ['ì‹œì¥', 'í¬ì¥ë§ˆì°¨', 'ì•¼ì‹'],
            menu: [ {item: 'ëª¨ë‘ íšŒ(ì†Œ)', price: 20000}, {item: 'ë–¡ë³¶ì´', price: 5000}, {item: 'ì˜¤ë©”ê¸°ë–¡', price: 5000} ],
            reviews: [ {author: 'ê¹€ì œì£¼', rating: 5, text: 'ë™ë¬¸ì‹œì¥ì€ ì œì£¼ ì—¬í–‰ì˜ í•„ìˆ˜ì½”ìŠ¤!'}, {author: 'ë°•ì—¬í–‰', rating: 4, text: 'ê°€ê²©ë„ ì €ë ´í•˜ê³  ì–‘ë„ ë§ì•„ìš”.'} ]
        },
        dombedon: {
            id: 'dombedon', name: 'ë”ë² ëˆ', rating: 4.6, reviewCount: 1247, cost: 130000, type: 'food',
            lat: 33.5148, lng: 126.5245, tags: ['í‘ë¼ì§€', 'ê³ ê¸°', 'í˜„ì§€ë§›ì§‘'],
            menu: [ {item: 'í‘ë¼ì§€ ëª©ì‚´', price: 28000}, {item: 'ê°ˆë§¤ê¸°ì‚´', price: 32000} ],
            reviews: [ {author: 'ê³ ê¸°ì™•', rating: 5, text: 'ì œì£¼ í‘ë¼ì§€ì˜ ì§„ì§œ ë§›ì„ ëŠë‚„ ìˆ˜ ìˆëŠ” ê³³!'} ]
        },
        // ... (ë‹¤ë¥¸ ìŒì‹ì  ë°ì´í„°)
    },
    cafes: {
        cafe_orda: {
            id: 'cafe_orda', name: 'ì¹´í˜ ì˜¤ë¥´ë‹¤', rating: 4.7, reviewCount: 1856, cost: 35000, type: 'cafe',
            lat: 33.4475, lng: 126.9323, tags: ['í¬í† ì¡´', 'ì˜¤ì…˜ë·°', 'ì¸ìŠ¤íƒ€'],
            menu: [ {item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 5500}, {item: 'í‘ì„ìë¼ë–¼', price: 6500} ],
            reviews: [ {author: 'ì¹´í˜ëŸ¬ë²„', rating: 5, text: 'ì²œêµ­ì˜ ê³„ë‹¨ìœ¼ë¡œ ìœ ëª…í•œ ê³³!'} ]
        },
        // ... (ë‹¤ë¥¸ ì¹´í˜ ë°ì´í„°)
    },
    attractions: {
        seongsan: {
            id: 'seongsan', name: 'ì„±ì‚°ì¼ì¶œë´‰', rating: 4.5, reviewCount: 5247, cost: 5000, type: 'activity',
            lat: 33.4581, lng: 126.9426, tags: ['ìœ ë„¤ìŠ¤ì½”', 'ì¼ì¶œ', 'í•„ìˆ˜ì½”ìŠ¤'],
            menu: [ {item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 5000} ],
            reviews: [ {author: 'ì¼ì¶œëŸ¬ë²„', rating: 5, text: 'ì œì£¼ ì—¬í–‰ 1ìˆœìœ„! ì¼ì¶œ ì‹œê°„ì— ë§ì¶° ê°€ì‹œê¸¸ ê°•ì¶”í•©ë‹ˆë‹¤.'} ]
        },
        aquaplanet: {
            id: 'aquaplanet', name: 'ì•„ì¿ ì•„í”Œë¼ë„· ì œì£¼', rating: 4.4, reviewCount: 3892, cost: 120000, type: 'activity',
            lat: 33.4320, lng: 126.9248, tags: ['ìˆ˜ì¡±ê´€', 'ì‹¤ë‚´', 'ê°€ì¡±'],
            menu: [ {item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 38000} ],
            reviews: [ {author: 'ê°€ì¡±ë‚˜ë“¤ì´', rating: 5, text: 'ì•„ì´ë“¤ì´ ì •ë§ ì¢‹ì•„í•´ìš”!'} ]
        },
        // ... (ë‹¤ë¥¸ ê´€ê´‘ì§€ ë°ì´í„°)
    }
};

// ì¼ì • ë°ì´í„°
const itineraryData = {
    day1: {
        title: "ì œì£¼ ë„ì°© & ì„¤ë ˆëŠ” ì²«ë‚  ë°¤",
        slots: {
            '18:00': { icon: 'âœˆï¸', category: 'ê³µí•­ ë„ì°©', options: { arrival: { id: 'arrival', name: 'ì œì£¼êµ­ì œê³µí•­', cost: 0, type: 'etc', tags: ['í•„ìˆ˜', 'ë„ì°©'], lat: 33.5104, lng: 126.4913 } } },
            '19:00': { icon: 'ğŸ¨', category: 'ìˆ™ì†Œ ì²´í¬ì¸', options: { checkin_hotel: { id: 'checkin_hotel', name: 'ì²´í¬ì¸í˜¸í…” ì œì£¼', cost: 0, type: 'accommodation', tags: ['1ì¼ì°¨ ìˆ™ì†Œ'], lat: 33.5015, lng: 126.5050 } } },
            '19:30': { icon: 'ğŸ´', category: 'ì €ë… ì‹ì‚¬', options: { dongmun_market: jejuDatabase.restaurants.dongmun_market, dombedon: jejuDatabase.restaurants.dombedon, } },
            '21:00': { icon: 'ğŸŒ™', category: 'ì•¼ê°„ í™œë™', options: { night_walk: { id: 'night_walk', name: 'ì´í˜¸í…Œìš° í•´ë³€', rating: 4.2, cost: 10000, type: 'etc', lat: 33.5127, lng: 126.4528, tags: ['ì•¼ê²½', 'í•´ë³€'] }, } }
        }
    },
    day2: {
        title: "í™˜ìƒì˜ ë™ìª½ í•´ì•ˆë„ë¡œ ì¼ì£¼",
        slots: {
            '10:30': { icon: 'ğŸï¸', category: 'ì˜¤ì „ í™œë™', options: { seongsan: jejuDatabase.attractions.seongsan } },
            '15:00': { icon: 'â˜•', category: 'ì¹´í˜ íƒ€ì„', options: { cafe_orda: jejuDatabase.cafes.cafe_orda } },
            '16:30': { icon: 'ğŸŒŠ', category: 'ì˜¤í›„ í™œë™', options: { aquaplanet: jejuDatabase.attractions.aquaplanet } }
        }
    },
    // ... (day3, day4 ë°ì´í„°)
};

// ì „ì—­ ë³€ìˆ˜
let googleMap, placesService, directionsService, directionsRenderer;
let activeDay = 1;
let selections = {};
let originalSelections = {};
let isNaviModeActive = false;
let watchId = null;
let userLocationMarker = null;
// !!! ì¤‘ìš”: ì‹¤ì œ ì—¬í–‰ ì‹œì‘ì¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš” !!!
const tripStartDate = new Date('2024-07-25'); 

// ì´ˆê¸°í™”
function initApp() {
    initUI();
    initMap();
    setupEventListeners();
    setupInitialState();
    autoSelectToday();
}

function autoSelectToday() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startDate = new Date(tripStartDate.valueOf());
    startDate.setHours(0, 0, 0, 0);

    const diffTime = today - startDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

    if (diffDays >= 1 && diffDays <= Object.keys(itineraryData).length) {
        switchDay(diffDays);
    }
}

function initUI() {
    const tabsContainer = document.getElementById('day-tabs-container');
    const itineraryContainer = document.getElementById('itinerary-container');
    
    Object.keys(itineraryData).forEach((dayKey, index) => {
        const day = parseInt(dayKey.replace('day', ''));
        const tab = document.createElement('button');
        tab.className = `day-tab ${index === 0 ? 'active' : ''}`;
        tab.textContent = `${day}ì¼ì°¨`;
        tab.dataset.day = day;
        tab.onclick = () => switchDay(day);
        tabsContainer.appendChild(tab);
    });

    Object.keys(itineraryData).forEach((dayKey, index) => {
        const day = parseInt(dayKey.replace('day', ''));
        const dayData = itineraryData[dayKey];
        
        const dayContent = document.createElement('div');
        dayContent.id = `day${day}`;
        dayContent.className = `day-content ${index > 0 ? 'hidden' : ''}`;
        dayContent.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">${dayData.title}</h2>
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${Object.entries(dayData.slots).map(([time, slot]) => `
                        <div class="relative mb-8 p-3" data-timeslot-wrapper="${time}">
                            <div class="timeline-dot"></div>
                            <div class="ml-8">
                                <div class="flex items-center mb-4">
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold mr-3">${time}</span>
                                    <h3 class="text-base font-bold text-gray-800">${slot.icon} ${slot.category}</h3>
                                    <div class="distance-info ml-auto" data-day="${day}" data-time="${time}"></div>
                                </div>
                                <div class="options-grid grid grid-cols-2 md:grid-cols-3 gap-2" data-day="${day}" data-time="${time}">
                                    ${slot.options ? generateOptionsHtml(day, time, slot.options) : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        itineraryContainer.appendChild(dayContent);
    });
}

function generateOptionsHtml(day, time, options) {
    let optionNumber = 1;
    return Object.entries(options).map(([id, option]) => `
        <div class="option-card" 
             data-id="${option.id}" data-name="${option.name}" data-cost="${option.cost}" 
             data-type="${option.type}" data-lat="${option.lat}" data-lng="${option.lng}"
             data-day="${day}" data-time="${time}"
             onclick="handleOptionSelect(${day}, '${time}', this)">
            <h4 class="font-bold text-gray-800 text-sm mb-2 pr-2">${option.name}</h4>
            ${option.rating ? `<div class="flex items-center mb-2 text-xs"><div class="rating-stars mr-1 text-yellow-400">${'â˜…'.repeat(Math.floor(option.rating))}</div><span class="text-gray-600">${option.rating}</span></div>` : ''}
             <div class="flex items-center justify-between">
                <div class="flex flex-wrap gap-1">
                    ${(option.tags || []).slice(0, 2).map(tag => `<span class="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${tag}</span>`).join('')}
                </div>
                <span class="text-xs font-bold text-green-600">â‚©${(option.cost/1000)}K</span>
             </div>
        </div>
    `).join('');
}

function setupEventListeners() {
    document.getElementById('navi-mode-toggle').onclick = toggleNaviMode;
    document.getElementById('reset-button').onclick = resetToOriginal;
    // Add other event listeners for theme search, collapsible cards etc. if needed
}

function setupInitialState() {
    Object.keys(itineraryData).forEach(dayKey => {
        const day = parseInt(dayKey.replace('day', ''));
        selections[day] = {};
        Object.entries(itineraryData[dayKey].slots).forEach(([time, slot]) => {
            if (slot.options) {
                const firstOptionKey = Object.keys(slot.options)[0];
                const optionData = slot.options[firstOptionKey];
                selections[day][time] = { ...optionData };
                const card = document.querySelector(`.option-card[data-day="${day}"][data-time="${time}"]`);
                if (card) { card.classList.add('selected'); }
            }
        });
    });
    originalSelections = JSON.parse(JSON.stringify(selections));
    updateMapForDay(activeDay);
}

function switchDay(day) {
    activeDay = day;
    document.querySelectorAll('.day-tab').forEach(tab => {
        tab.classList.toggle('active', parseInt(tab.dataset.day) === day);
        if (parseInt(tab.dataset.day) === day) {
            tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }
    });
    document.querySelectorAll('.day-content').forEach(content => {
        content.classList.toggle('hidden', parseInt(content.id.replace('day', '')) !== day);
    });
    
    if (isNaviModeActive && userLocationMarker) {
        updateLiveStatus(userLocationMarker.getPosition());
    } else {
        clearLiveStatus();
    }
    updateMapForDay(day);
}

function handleOptionSelect(day, time, cardElement) {
    const grid = cardElement.closest('.options-grid');
    grid.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
    cardElement.classList.add('selected');
    
    const optionData = {
        id: cardElement.dataset.id,
        name: cardElement.dataset.name,
        cost: parseInt(cardElement.dataset.cost),
        type: cardElement.dataset.type,
        lat: parseFloat(cardElement.dataset.lat),
        lng: parseFloat(cardElement.dataset.lng)
    };
    selections[day][time] = optionData;
    updateMapForDay(day);
    if (isNaviModeActive && userLocationMarker) {
        updateLiveStatus(userLocationMarker.getPosition());
    }
}

function resetToOriginal() {
    if (confirm('ì›ë˜ ê³„íšëœ ì¼ì •ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        selections = JSON.parse(JSON.stringify(originalSelections));
        document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
        Object.keys(originalSelections).forEach(day => {
            Object.keys(originalSelections[day]).forEach(time => {
                const selection = originalSelections[day][time];
                const card = document.querySelector(`.option-card[data-day="${day}"][data-time="${time}"][data-id="${selection.id}"]`);
                if (card) card.classList.add('selected');
            });
        });
        updateMapForDay(activeDay);
        if (isNaviModeActive && userLocationMarker) {
            updateLiveStatus(userLocationMarker.getPosition());
        }
    }
}

function initMap() {
    try {
        googleMap = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 33.385, lng: 126.55 }, zoom: 9,
            styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }],
            disableDefaultUI: true, zoomControl: true
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#4f46e5', strokeWeight: 5, strokeOpacity: 0.8 } });
        directionsRenderer.setMap(googleMap);
    } catch (e) {
        document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-500">ì§€ë„ ë¡œë”© ì‹¤íŒ¨</div>';
    }
}

function updateMapForDay(day) {
    if (!googleMap) return;
    
    const daySelections = Object.values(selections[day] || {}).filter(s => s && s.lat && s.lng);
    daySelections.sort((a, b) => {
        const timeA = Object.keys(selections[day]).find(key => selections[day][key] && selections[day][key].id === a.id);
        const timeB = Object.keys(selections[day]).find(key => selections[day][key] && selections[day][key].id === b.id);
        return timeA && timeB ? timeA.localeCompare(timeB) : 0;
    });

    if (window.dayMarkers) { window.dayMarkers.forEach(m => m.setMap(null)); }
    window.dayMarkers = [];
    directionsRenderer.setDirections({routes: []});
    
    if (daySelections.length === 0) return;

    const bounds = new google.maps.LatLngBounds();
    daySelections.forEach((sel, index) => {
        const pos = { lat: sel.lat, lng: sel.lng };
        bounds.extend(pos);
        const marker = new google.maps.Marker({
            position: pos, map: googleMap,
            label: { text: `${index + 1}`, color: 'white', fontWeight: 'bold' },
            title: sel.name, zIndex: 1000 + index
        });
        window.dayMarkers.push(marker);
    });

    if (daySelections.length > 1) {
        const request = {
            origin: { lat: daySelections[0].lat, lng: daySelections[0].lng },
            destination: { lat: daySelections[daySelections.length - 1].lat, lng: daySelections[daySelections.length - 1].lng },
            waypoints: daySelections.slice(1, -1).map(s => ({ location: { lat: s.lat, lng: s.lng } })),
            travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, (result, status) => { if (status === 'OK') { directionsRenderer.setDirections(result); } });
    }
    
    if (userLocationMarker) bounds.extend(userLocationMarker.getPosition());
    googleMap.fitBounds(bounds);
    if (googleMap.getZoom() > 15) googleMap.setZoom(15);
}

function openInGoogleMaps() {
    const daySels = Object.values(selections[activeDay] || {}).filter(s => s && s.lat);
    if (daySels.length < 1) { alert("ë¨¼ì € ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    
    let url = 'https://www.google.com/maps/dir/';
    if (userLocationMarker) {
        const pos = userLocationMarker.getPosition();
        url += `${pos.lat()},${pos.lng()}/`;
    }
    daySels.forEach(sel => { url += `${sel.lat},${sel.lng}/`; });
    window.open(url, '_blank');
}

// --- ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´ ê´€ë ¨ ë¡œì§ ---
function toggleNaviMode() {
    const toggleButton = document.getElementById('navi-mode-toggle');
    isNaviModeActive = !isNaviModeActive;

    if (isNaviModeActive) {
        if (navigator.geolocation) {
            toggleButton.innerHTML = '<i class="loading-spinner mr-2"></i>GPS ì—°ê²° ì¤‘...';
            watchId = navigator.geolocation.watchPosition(handleLocationUpdate, handleLocationError, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            isNaviModeActive = false;
        }
    } else {
        if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        watchId = null;
        if (userLocationMarker) { userLocationMarker.setMap(null); userLocationMarker = null; }
        
        toggleButton.innerHTML = '<i class="fas fa-location-arrow mr-1"></i>Live GPS ì¼œê¸°';
        toggleButton.classList.remove('bg-green-600', 'text-white');
        toggleButton.classList.add('bg-blue-100', 'text-blue-800');
        clearLiveStatus();
        updateMapForDay(activeDay); // ì§€ë„ ë·° ë¦¬í”„ë ˆì‹œ
    }
}

function handleLocationUpdate(position) {
    const userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    const toggleButton = document.getElementById('navi-mode-toggle');
    
    toggleButton.innerHTML = '<i class="fas fa-location-arrow mr-1"></i>Live GPS ë„ê¸°';
    toggleButton.classList.remove('bg-blue-100', 'text-blue-800');
    toggleButton.classList.add('bg-green-600', 'text-white');

    if (!userLocationMarker) {
        userLocationMarker = new google.maps.Marker({
            position: userLocation, map: googleMap,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 },
            title: "í˜„ì¬ ë‚´ ìœ„ì¹˜", zIndex: 2000
        });
        googleMap.setZoom(14);
    } else {
        userLocationMarker.setPosition(userLocation);
    }
    
    googleMap.panTo(userLocation);
    updateLiveStatus(userLocation);
}

function handleLocationError(error) {
    alert(`ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
    toggleNaviMode();
}

function updateLiveStatus(userLocation) {
    clearLiveStatus();
    
    const daySelections = selections[activeDay] || {};
    const sortedTimes = Object.keys(daySelections).sort();
    let nextDestinationFound = false;

    const now = new Date();
    const currentTimeStr = now.toTimeString().substring(0, 5);

    sortedTimes.forEach(time => {
        const destination = daySelections[time];
        if (destination && destination.lat) {
            const destLatLng = new google.maps.LatLng(destination.lat, destination.lng);
            const distanceInMeters = google.maps.geometry.spherical.computeDistanceBetween(userLocation, destLatLng);
            const distanceInKm = (distanceInMeters / 1000).toFixed(1);

            const distanceEl = document.querySelector(`.distance-info[data-day="${activeDay}"][data-time="${time}"]`);
            if (distanceEl) {
                distanceEl.innerHTML = `ğŸ“ í˜„ì¬ ${distanceInKm}km`;
            }

            if (!nextDestinationFound && time > currentTimeStr) {
                const wrapper = document.querySelector(`[data-timeslot-wrapper="${time}"]`);
                if (wrapper) {
                    wrapper.classList.add('live-next-item');
                    const nextBadge = document.createElement('div');
                    nextBadge.className = 'next-badge';
                    nextBadge.innerText = 'NEXT';
                    wrapper.appendChild(nextBadge);
                }
                nextDestinationFound = true;
            }
        }
    });
}

function clearLiveStatus() {
    document.querySelectorAll('.distance-info').forEach(el => el.innerHTML = '');
    document.querySelectorAll('.live-next-item').forEach(el => el.classList.remove('live-next-item'));
    document.querySelectorAll('.next-badge').forEach(el => el.remove());
}
</script>
</body>
</html>
