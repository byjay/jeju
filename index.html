모든게 안된다 다시 아래코드에서 시작해
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강귀선님을위한 제주여행 플래너 </title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 요청하신 API 키를 직접 반영했습니다. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkmhTzFKcxxfQIrYlkcFjXAgIDdTZMdvU&callback=initApp&libraries=places,directions,geometry&v=weekly" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f7fafc; }
        .day-tab.active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .option-card { transition: all 0.2s ease-in-out; border-width: 2px; }
        .option-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .option-card.selected { border-color: #6366f1; background-color: #eef2ff; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        .details-panel { overflow: hidden; transition: all 0.3s ease-in-out; height: 0; margin-top: 0; opacity: 0; }
        .details-panel.open { margin-top: 1rem; opacity: 1; }
        .details-tab { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .details-tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .loading-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px; color: #6b7280; text-align: center;}
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-bottom: 0.5rem;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #navi-mode-toggle.active { background-color: #10b981; }
        .distance-info { font-size: 0.75rem; font-weight: 600; color: #10b981; margin-left: auto; }
        .input-cost-field { width: 100%; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8rem; text-align: right; }
        .compact-timeline { padding-left: 1.5rem; }
        .timeline-dot { left: -6px; width: 12px; height: 12px; }
        
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; flex-direction: column; }
        .fullscreen-modal.active { display: flex; }
        .fullscreen-header { flex-shrink: 0; background-color: #1f2937; color: white; }
        .fullscreen-content { flex-grow: 1; display: flex; overflow: hidden; }
        .fullscreen-map-container { flex-grow: 1; position: relative; }
        .fullscreen-map { width: 100%; height: 100%; }
        .map-sidebar { width: 400px; flex-shrink: 0; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; }
        .place-card { cursor: pointer; border-bottom: 1px solid #e5e7eb; padding: 1rem; transition: background-color 0.2s; }
        .place-card:hover { background-color: #f9fafb; }
        .place-card.selected { background-color: #dbeafe; border-left: 4px solid #3b82f6; }

        .place-detail-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 10002; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: none; }
        .place-detail-modal.active { display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: none; }
        .modal-overlay.active { display: block; }

        @media print {
            body { background-color: white !important; }
            .no-print { display: none !important; }
        }
        @media (max-width: 1024px) {
            .fullscreen-content { flex-direction: column-reverse; }
            .map-sidebar { width: 100%; height: 50%; }
            .fullscreen-map-container { height: 50%; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg no-print">
        <div class="max-w-screen-xl mx-auto px-4 py-4 text-center">
            <h1 class="text-3xl font-bold">🏝️ 강귀선님을 위한 제주여행 플래너 by bong</h1>
            <p class="text-lg mt-1 opacity-90">우리집 먹투어를 위한 스마트 플래너 </p>
        </div>
    </div>

    <div class="max-w-screen-xl mx-auto p-3">
        <!-- 컨트롤 패널 -->
        <div class="flex flex-wrap justify-center items-center mb-4 bg-white p-2 rounded-xl shadow-md gap-2 no-print">
            <div class="flex-grow flex justify-center" id="day-tabs-container"></div>
            <button id="theme-search-toggle" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-search-location mr-2"></i>주변 맛집/카페 검색
            </button>
            <button id="reset-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-undo mr-2"></i>리셋
            </button>
            <button id="navi-mode-toggle" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-location-arrow mr-2"></i>Live GPS
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
            <!-- 일정 패널 -->
            <div id="itinerary-container" class="lg:col-span-4 space-y-4"></div>
            
            <!-- 사이드바 -->
            <div class="lg:col-span-3">
                <div class="sticky top-4 space-y-4">
                    <!-- 지도 -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-map-marked-alt mr-2"></i>실시간 지도 & 경로</h3>
                        <div id="map" class="w-full h-64 bg-gray-200"></div>
                        <div class="p-3"><button onclick="openInGoogleMaps()" class="w-full bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-700 transition text-sm"><i class="fas fa-directions mr-1"></i>구글맵에서 길찾기</button></div>
                    </div>
                    <!-- 선택 일정 -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-tasks mr-2"></i>오늘의 여행 계획</h3>
                        <div id="selected-items-container" class="p-3 max-h-48 overflow-y-auto"></div>
                    </div>
                    <!-- 경비 계산 -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-coins mr-2"></i>여행 경비 계산</h3>
                        <div class="p-3 space-y-3">
                             <div>
                                <h4 class="font-semibold text-gray-700 mb-2 text-sm">직접 입력</h4>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div><label for="flight-cost" class="block text-gray-600 mb-1">항공료</label><input type="number" id="flight-cost" class="input-cost-field" placeholder="400,000" step="10000"></div>
                                    <div><label for="hotel-cost" class="block text-gray-600 mb-1">숙박비</label><input type="number" id="hotel-cost" class="input-cost-field" placeholder="500,000" step="10000"></div>
                                </div>
                            </div>
                            <div class="border-t pt-3">
                                <h4 class="font-semibold text-gray-700 mb-2 text-sm">현지 경비</h4>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between items-center"><span class="text-gray-600">🍴 식비</span><span class="font-semibold" id="cost-food">₩0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">🎟️ 체험/입장</span><span class="font-semibold" id="cost-activity">₩0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">☕ 기타</span><span class="font-semibold" id="cost-etc">₩0</span></div>
                                </div>
                            </div>
                            <div class="pt-3 border-t-2 text-center bg-yellow-50 p-2 rounded-lg">
                                <p class="text-xs text-gray-600">총 예상 여행 경비</p>
                                <p class="text-xl font-bold text-red-600" id="total-cost">₩0</p>
                            </div>
                        </div>
                    </div>
                    <!-- 숙소 정보 -->
                    <div class="bg-white rounded-xl shadow-lg">
                         <h3 class="text-base font-bold text-white bg-gray-800 p-3 rounded-t-xl flex items-center"><i class="fas fa-bed mr-2"></i>추천 숙소</h3>
                         <div class="p-3 space-y-2 text-xs">
                            <div class="border-b pb-2"><p class="font-semibold">1일차 숙소</p><a href="https://www.agoda.com/sl/cmP0tfukS0y" target="_blank" class="text-blue-600 hover:underline">체크인호텔 제주</a></div>
                            <div class="border-b pb-2"><p class="font-semibold">2일차 숙소</p><a href="https://www.agoda.com/sl/GPG0yhcNtzR" target="_blank" class="text-blue-600 hover:underline">더 퍼스트 70 호텔</a></div>
                            <div><p class="font-semibold">3일차 숙소</p><a href="https://www.genspark.ai/agents?id=27c0c28f-babb-4e5a-a594-7d2b396e6722" target="_blank" class="text-blue-600 hover:underline">판포포구 프리미엄 스테이</a></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 전체화면 테마 검색 모달 -->
    <div id="fullscreen-modal" class="fullscreen-modal">
        <div class="fullscreen-header p-4 flex justify-between items-center"><h2 class="text-xl font-bold">주변 맛집/카페 검색</h2><button id="close-fullscreen" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-times mr-2"></i>닫기</button></div>
        <div class="fullscreen-content">
            <div class="map-sidebar">
                <div class="sidebar-header">
                    <div class="mb-4"><input type="text" id="theme-keyword-search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="키워드 검색 (예: 흑돼지, 오션뷰)"></div>
                    <div class="flex gap-2">
                        <select id="theme-category-filter" class="w-1/2 p-2 border border-gray-300 rounded-lg"><option value="all">맛집 & 카페</option><option value="restaurant">맛집만</option><option value="cafe">카페만</option></select>
                        <select id="theme-sort-order" class="w-1/2 p-2 border border-gray-300 rounded-lg"><option value="score">추천순</option><option value="rating">별점순</option><option value="distance">거리순</option></select>
                    </div>
                </div>
                <div id="search-results" class="sidebar-content"></div>
            </div>
            <div class="fullscreen-map-container"><div id="fullscreen-map" class="fullscreen-map"></div></div>
        </div>
    </div>
    <!-- 장소 상세 정보 모달 -->
    <div id="modal-overlay" class="modal-overlay"></div>
    <div id="place-detail-modal" class="place-detail-modal">
        <div class="flex justify-between items-center mb-4"><h2 id="place-name" class="text-xl font-bold"></h2><button id="close-detail-modal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
        <div id="place-details" class="space-y-4"></div>
    </div>
<script>
// --- 데이터베이스 ---

// 제주패스 가맹점 시뮬레이션 데이터
const jejuPassData = [
    { id: 'jp_snoopy', name: '스누피가든', type: 'activity', lat: 33.4253, lng: 126.7958, cost: 36000, tags: ['테마파크', '포토존', '동부'] },
    { id: 'jp_arte', name: '아르떼뮤지엄 제주', type: 'activity', lat: 33.4116, lng: 126.3059, cost: 34000, tags: ['미디어아트', '실내', '서부'] },
    { id: 'jp_981', name: '9.81파크', type: 'activity', lat: 33.4147, lng: 126.3228, cost: 99000, tags: ['그래비티레이싱', '액티비티', '서부'] },
    { id: 'jp_wind1947', name: '윈드1947카트테마파크', type: 'activity', lat: 33.2758, lng: 126.5516, cost: 50000, tags: ['카트', '액티비티', '남부'] },
    { id: 'jp_ecoland', name: '에코랜드 테마파크', type: 'activity', lat: 33.4533, lng: 126.6713, cost: 28000, tags: ['기차여행', '곶자왈', '동부'] },
    { id: 'jp_camellia', name: '카멜리아힐', type: 'activity', lat: 33.2913, lng: 126.3688, cost: 18000, tags: ['수목원', '꽃', '남서부'] },
    { id: 'jp_skywater', name: '스카이워터쇼', type: 'activity', lat: 33.3941, lng: 126.7937, cost: 40000, tags: ['공연', '실내', '동부'] },
    { id: 'jp_hueree', name: '휴애리 자연생활공원', type: 'activity', lat: 33.2872, lng: 126.6025, cost: 26000, tags: ['자연', '동물먹이주기', '남부'] },
    { id: 'jp_aerospace', name: '제주항공우주박물관', type: 'activity', lat: 33.3039, lng: 126.2917, cost: 20000, tags: ['박물관', '아이와함께', '서부'] },
    { id: 'jp_shinhwa', name: '신화워터파크', type: 'activity', lat: 33.3000, lng: 126.3150, cost: 78000, tags: ['워터파크', '여름', '서부'] },
    { id: 'jp_maze', name: '메이즈랜드', type: 'activity', lat: 33.5042, lng: 126.7865, cost: 22000, tags: ['미로공원', '동부'] },
    { id: 'jp_alive', name: '박물관은 살아있다', type: 'activity', lat: 33.2505, lng: 126.4111, cost: 24000, tags: ['트릭아트', '실내', '남서부'] },
    { id: 'jp_teddy', name: '테디베어뮤지엄', type: 'activity', lat: 33.2500, lng: 126.4120, cost: 26000, tags: ['박물관', '인형', '남서부'] },
    { id: 'jp_utopia', name: '뽀로로&타요 테마파크', type: 'activity', lat: 33.2933, lng: 126.3638, cost: 80000, tags: ['키즈파크', '아이와함께', '남서부'] },
    { id: 'jp_folkvillage', name: '제주민속촌', type: 'activity', lat: 33.3196, lng: 126.9099, cost: 22000, tags: ['전통', '역사', '동부'] },
    { id: 'jp_glasscastle', name: '유리의성', type: 'activity', lat: 33.3294, lng: 126.2753, cost: 24000, tags: ['유리공예', '포토존', '서부'] },
    { id: 'jp_ilchul', name: '일출랜드', type: 'activity', lat: 33.3643, lng: 126.8631, cost: 18000, tags: ['미천굴', '수목원', '동부'] },
    { id: 'jp_atv', name: '제주 성읍랜드 ATV', type: 'activity', lat: 33.3853, lng: 126.8062, cost: 50000, tags: ['ATV', '액티비티', '동부'] },
    { id: 'jp_ulsan', name: '울산큰애기', type: 'etc', lat: 33.2408, lng: 126.5645, cost: 20000, tags: ['카페', '서귀포', '남부'] },
    { id: 'jp_sungsan', name: '스타벅스 제주성산DT', type: 'etc', lat: 33.4522, lng: 126.9149, cost: 20000, tags: ['카페', '성산', '동부'] }
];

// 여행 일정 데이터 (jejuPassSearch 추가)
const itineraryData = {
    day1: {
        title: "제주 도착 & 설레는 첫날 밤",
        slots: {
            '18:00': { icon: '✈️', category: '공항 도착', options: { arrival: { id: 'arrival', name: '제주국제공항', cost: 0, type: 'etc', tags: ['필수'], lat: 33.5104, lng: 126.4913 } } },
            '19:00': { icon: '🏨', category: '숙소 체크인', options: { checkin_hotel: { id: 'checkin_hotel', name: '체크인호텔 제주', cost: 0, type: 'accommodation', tags: ['1일차 숙소'], lat: 33.5015, lng: 126.5050 } } },
            '19:30': { icon: '🍴', category: '저녁 식사', dynamicSearch: { type: 'food', keywords: ['흑돼지', '고기국수', '해물탕'], radius: 3000, minResults: 4 } },
            '21:00': { icon: '☕', category: '야간 카페', dynamicSearch: { type: 'cafe', keywords: ['야경 카페', '디저트'], radius: 5000, minResults: 4 } }
        }
    },
    day2: {
        title: "환상의 동쪽 해안도로 일주",
        slots: {
            '09:00': { icon: '🍳', category: '아침 식사', options: {
                dongmun: { id: 'dongmun', name: '동문시장', cost: 30000, type: 'food', tags: ['포장', '시장'], lat: 33.5126, lng: 126.5292, 
                    menu: [{item:'모둠회(소)', price:20000}, {item:'떡볶이', price:5000}] },
                brunch_d2: { id: 'brunch_d2', name: '이도동 브런치 카페', cost: 50000, type: 'food', tags: ['브런치'], lat: 33.5002, lng: 126.5310 }
            }},
            '10:30': { icon: '🎟️', category: '오전 활동 (PASS)', jejuPassSearch: { radius: 25000, minResults: 4 } }, // 제주패스 검색
            '13:00': { icon: '🍴', category: '점심 식사', dynamicSearch: { type: 'food', keywords: ['해물라면', '전복', '갈치'], radius: 7000, minResults: 4 } },
            '15:00': { icon: '🎟️', category: '오후 활동 (PASS)', jejuPassSearch: { radius: 15000, minResults: 4 } }, // 제주패스 검색
            '18:30': { icon: '🏨', category: '숙소 체크인', options: { thefirst70: { id: 'thefirst70', name: '더 퍼스트 70 호텔', cost: 0, type: 'accommodation', tags: ['2일차 숙소'], lat: 33.2476, lng: 126.5615 } } },
            '19:30': { icon: '🍢', category: '저녁 식사', dynamicSearch: { type: 'food', keywords: ['흑돼지', '횟집', '올레시장'], radius: 1500, minResults: 4 } }
        }
    },
    day3: {
        title: "서귀포 자연과 서쪽의 낭만",
        slots: {
            '09:30': { icon: '🎟️', category: '오전 활동 (PASS)', jejuPassSearch: { radius: 20000, minResults: 4 } }, // 제주패스 검색
            '12:30': { icon: '🍴', category: '점심 식사', dynamicSearch: { type: 'food', keywords: ['갈치조림', '보말칼국수'], radius: 8000, minResults: 4 } },
            '14:30': { icon: '🎟️', category: '오후 활동 (PASS)', jejuPassSearch: { radius: 15000, minResults: 4 } }, // 제주패스 검색
            '17:00': { icon: '🏨', category: '숙소 체크인', options: { airbnb: { id: 'airbnb', name: '판포포구 프리미엄 스테이', cost: 0, type: 'accommodation', tags: ['3일차 숙소'], lat: 33.3857, lng: 126.2104 } } },
            '18:30': { icon: '🌅', category: '저녁 식사', dynamicSearch: { type: 'food', keywords: ['흑돼지', '오션뷰 레스토랑'], radius: 5000, minResults: 4 } }
        }
    },
    day4: {
        title: "아쉬운 마지막 날 & 출발",
        slots: {
            '10:00': { icon: '🎟️', category: '오전 활동 (PASS)', jejuPassSearch: { radius: 15000, minResults: 4 } }, // 제주패스 검색
            '13:00': { icon: '🍴', category: '마지막 점심', dynamicSearch: { type: 'food', keywords: ['해물라면', '수제버거'], radius: 10000, minResults: 4 } },
            '14:30': { icon: '🎁', category: '기념품 & 반납', options: { shopping: { id: 'shopping', name: '렌트카 반납', cost: 50000, type: 'etc', tags: ['쇼핑'], lat: 33.5049, lng: 126.4950 } } },
            '18:00': { icon: '🛫', category: '제주공항 출발', options: { departure: { id: 'departure', name: '여행 마무리', cost: 0, type: 'etc', tags: ['필수'], lat: 33.5104, lng: 126.4913 } } }
        }
    }
};

// --- 전역 변수 ---
let googleMap, fullscreenMap, placesService, directionsService, directionsRenderer;
let activeDay = 1;
const selections = {};
let originalSelections = {};
let isNaviModeActive = false;
let watchId = null;
let userLocationMarker = null;
let fullscreenUserMarker = null;
let fullscreenMarkers = [];
let allThemeResults = [];
let currentSearchLocation = null;
const fixedCosts = { flight: 0, hotel: 0 };


// --- 초기화 및 UI 설정 함수 ---
function initApp() {
    initUI();
    initMap();
    setupEventListeners();
}

function initUI() {
    const tabsContainer = document.getElementById('day-tabs-container');
    const itineraryContainer = document.getElementById('itinerary-container');
    tabsContainer.innerHTML = ''; 
    itineraryContainer.innerHTML = '';

    Object.keys(itineraryData).forEach((dayKey, index) => {
        const day = parseInt(dayKey.replace('day', ''));
        const tab = document.createElement('button');
        tab.className = `day-tab px-3 py-2 rounded-lg font-semibold transition text-sm ${index === 0 ? 'active' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`;
        tab.textContent = `${day}일차`;
        tab.dataset.day = day;
        tabsContainer.appendChild(tab);
        const dayContent = document.createElement('div');
        dayContent.id = `day${day}`;
        dayContent.className = `day-content space-y-3 ${index > 0 ? 'hidden' : ''}`;
        dayContent.innerHTML = `<h2 class="text-xl font-bold text-gray-800">${itineraryData[dayKey].title}</h2>`;
        Object.entries(itineraryData[dayKey].slots).forEach(([time, slot]) => {
            dayContent.innerHTML += `<div class="compact-timeline relative"><div class="absolute left-0 top-1 h-full border-l-2 border-gray-300"></div><div class="timeline-dot absolute bg-blue-500 rounded-full border-2 border-white"></div><div class="bg-white rounded-lg shadow-md p-4"><div class="flex items-center mb-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold mr-3">${time}</span><h3 class="text-base font-bold text-gray-800">${slot.icon} ${slot.category}</h3><div class="distance-info" data-day="${day}" data-time="${time}"></div></div><div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-3" data-day="${day}" data-time="${time}">${slot.options ? generateOptionsHtml(day, time, slot.options) : ''}</div></div></div>`;
        });
        itineraryContainer.appendChild(dayContent);
    });
    
    setupInitialState();
}

function initMap() {
    try {
        const jejuCenter = { lat: 33.385, lng: 126.55 };
        googleMap = new google.maps.Map(document.getElementById('map'), { center: jejuCenter, zoom: 9, styles: [{featureType: "poi",elementType: "labels",stylers: [{ visibility: "off" }]}] });
        fullscreenMap = new google.maps.Map(document.getElementById('fullscreen-map'), { center: jejuCenter, zoom: 10, styles: [{featureType: "poi",elementType: "labels",stylers: [{ visibility: "off" }]}] });
        placesService = new google.maps.places.PlacesService(googleMap);
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#4f46e5', strokeWeight: 4, strokeOpacity: 0.8 } });
        directionsRenderer.setMap(googleMap);
        updateMapForDay(1);
    } catch (e) { document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 text-sm">지도 로딩 실패</div>'; }
}

function setupEventListeners() {
    document.getElementById('day-tabs-container').addEventListener('click', e => { if (e.target.classList.contains('day-tab')) switchDay(parseInt(e.target.dataset.day)); });
    document.getElementById('itinerary-container').addEventListener('click', e => { const card = e.target.closest('.option-card'); if (card) { handleOptionSelect(parseInt(card.closest('.options-grid').dataset.day), card.closest('.options-grid').dataset.time, card); } });
    document.getElementById('theme-search-toggle').onclick = openThemeSearchModal;
    document.getElementById('reset-button').onclick = resetToOriginal;
    document.getElementById('navi-mode-toggle').onclick = toggleNaviMode;
    document.getElementById('close-fullscreen').onclick = closeFullscreenModal;
    document.getElementById('close-detail-modal').onclick = closeDetailModal;
    document.getElementById('modal-overlay').onclick = closeDetailModal;
    document.getElementById('flight-cost').onchange = e => { fixedCosts.flight = parseInt(e.target.value) || 0; updateAllDisplays(); };
    document.getElementById('hotel-cost').onchange = e => { fixedCosts.hotel = parseInt(e.target.value) || 0; updateAllDisplays(); };
    
    document.getElementById('theme-keyword-search').addEventListener('input', renderFilteredResults);
    document.getElementById('theme-category-filter').addEventListener('change', renderFilteredResults);
    document.getElementById('theme-sort-order').addEventListener('change', renderFilteredResults);
}

async function setupInitialState() {
    for (const dayKey of Object.keys(itineraryData)) {
        const day = parseInt(dayKey.replace('day', ''));
        selections[day] = {};
        let lastLocation = null;
        for (const [time, slot] of Object.entries(itineraryData[dayKey].slots)) {
            if (slot.options) {
                const firstOptionKey = Object.keys(slot.options)[0];
                const optionData = slot.options[firstOptionKey];
                selections[day][time] = { ...optionData };
                lastLocation = { lat: optionData.lat, lng: optionData.lng };
                const card = document.querySelector(`.options-grid[data-day="${day}"][data-time="${time}"] .option-card`);
                if(card) card.classList.add('selected');
            } else if (lastLocation && day === 1) { // 1일차만 미리 검색
                 if (slot.dynamicSearch) await performNearbySearch(day, time, lastLocation, slot.dynamicSearch);
                 if (slot.jejuPassSearch) await performJejuPassSearch(day, time, lastLocation, slot.jejuPassSearch);
            }
        }
    }
    originalSelections = JSON.parse(JSON.stringify(selections));
    updateAllDisplays();
}


// --- 테마 검색 (맛집/카페) 기능 ---
function openThemeSearchModal() {
    const useCurrentLocation = confirm("현재 위치를 기준으로 검색하시겠습니까?\n(취소를 누르면 제주도 중심으로 검색합니다)");
    if (useCurrentLocation) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                startThemeSearch(userLoc);
            }, () => {
                alert("위치 정보를 가져올 수 없습니다. 제주도 중심으로 검색합니다.");
                startThemeSearch({ lat: 33.385, lng: 126.55 });
            });
        } else {
            alert("브라우저가 위치 정보를 지원하지 않습니다. 제주도 중심으로 검색합니다.");
            startThemeSearch({ lat: 33.385, lng: 126.55 });
        }
    } else {
        startThemeSearch({ lat: 33.385, lng: 126.55 });
    }
}

async function startThemeSearch(location) {
    currentSearchLocation = location;
    document.getElementById('fullscreen-modal').classList.add('active');
    fullscreenMap.setCenter(location);
    fullscreenMap.setZoom(11);

    const searchResultsContainer = document.getElementById('search-results');
    searchResultsContainer.innerHTML = `<div class="loading-container p-8"><div class="spinner"></div><span>맛집과 카페를 검색 중입니다...</span></div>`;

    clearFullscreenMarkers();
    
    if (fullscreenUserMarker) fullscreenUserMarker.setMap(null);
    fullscreenUserMarker = new google.maps.Marker({
        position: location,
        map: fullscreenMap,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 },
        title: "검색 기준 위치"
    });

    const restaurantPromise = nearbySearchPromise({ location, keyword: '제주도 식당', type: 'restaurant', radius: 20000 });
    const cafePromise = nearbySearchPromise({ location, keyword: '제주도 카페', type: 'cafe', radius: 20000 });

    try {
        const [restaurantResults, cafeResults] = await Promise.all([restaurantPromise, cafePromise]);
        const combinedResults = [...restaurantResults, ...cafeResults];
        const uniqueResults = Array.from(new Map(combinedResults.map(item => [item.place_id, item])).values());
        
        allThemeResults = uniqueResults
            .filter(p => p.rating && p.rating >= 4.0 && p.user_ratings_total > 30 && p.business_status === 'OPERATIONAL')
            .map(p => {
                const distance = google.maps.geometry.spherical.computeDistanceBetween( new google.maps.LatLng(location.lat, location.lng), p.geometry.location) / 1000;
                const score = (p.rating * 2) + Math.log10(p.user_ratings_total + 1);
                return { ...p, distance, score, types: p.types || [] };
            });
        renderFilteredResults();
    } catch (error) {
        searchResultsContainer.innerHTML = `<div class="p-8 text-center text-red-500">검색 중 오류가 발생했습니다: ${error.message}</div>`;
    }
}

function nearbySearchPromise(request) {
    const fullscreenPlacesService = new google.maps.places.PlacesService(fullscreenMap);
    return new Promise((resolve, reject) => {
        fullscreenPlacesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK || status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                resolve(results || []);
            } else { reject(new Error(`Places API Error: ${status}`)); }
        });
    });
}

function renderFilteredResults() {
    const keyword = document.getElementById('theme-keyword-search').value.toLowerCase();
    const category = document.getElementById('theme-category-filter').value;
    const sortOrder = document.getElementById('theme-sort-order').value;
    let filtered = allThemeResults;
    if (category !== 'all') { filtered = filtered.filter(p => p.types.includes(category)); }
    if (keyword) { filtered = filtered.filter(p => p.name.toLowerCase().includes(keyword) || (p.vicinity && p.vicinity.toLowerCase().includes(keyword))); }
    switch(sortOrder) {
        case 'rating': filtered.sort((a,b) => b.rating - a.rating); break;
        case 'distance': filtered.sort((a,b) => a.distance - b.distance); break;
        case 'score': default: filtered.sort((a,b) => b.score - a.score); break;
    }
    displaySearchResults(filtered);
    createFullscreenMarkers(filtered);
}

function displaySearchResults(results) {
    const container = document.getElementById('search-results');
    if (results.length === 0) { container.innerHTML = `<div class="p-8 text-center text-gray-500">조건에 맞는 검색 결과가 없습니다.</div>`; return; }
    container.innerHTML = results.map(place => generatePlaceCardHtml(place)).join('');
    container.querySelectorAll('.place-card').forEach(card => {
        card.addEventListener('click', () => {
            const placeId = card.dataset.placeId;
            const place = results.find(p => p.place_id === placeId);
            container.querySelectorAll('.place-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectPlaceOnMap(place);
            showPlaceDetail(place);
        });
    });
}

function generatePlaceCardHtml(place) {
    const isRestaurant = place.types.includes('restaurant');
    return `<div class="place-card" data-place-id="${place.place_id}"><div class="flex justify-between items-start"><h3 class="font-bold text-base pr-2">${isRestaurant ? '🍽️' : '☕'} ${place.name}</h3><span class="text-sm font-bold text-blue-600">${place.distance.toFixed(1)}km</span></div><div class="flex items-center text-sm text-gray-600 mt-1"><span class="text-yellow-500">⭐</span><span class="font-semibold ml-1">${place.rating}</span><span class="ml-2">(${place.user_ratings_total} 리뷰)</span><span class="ml-auto text-xs bg-gray-200 px-2 py-1 rounded-full">${isRestaurant ? '맛집' : '카페'}</span></div><p class="text-xs text-gray-500 mt-2">${place.vicinity || ''}</p></div>`;
}

function createFullscreenMarkers(places) {
    clearFullscreenMarkers(false);
    const bounds = new google.maps.LatLngBounds();
    if(fullscreenUserMarker) bounds.extend(fullscreenUserMarker.getPosition());
    places.forEach(place => {
        const marker = new google.maps.Marker({
            position: place.geometry.location, map: fullscreenMap, title: place.name,
            icon: { url: place.types.includes('restaurant') ? 'https://maps.google.com/mapfiles/ms/icons/restaurant.png' : 'https://maps.google.com/mapfiles/ms/icons/coffeehouse.png', scaledSize: new google.maps.Size(32, 32) }
        });
        marker.addListener('click', () => {
            const card = document.querySelector(`.place-card[data-place-id="${place.place_id}"]`);
            if (card) { document.querySelectorAll('.place-card').forEach(c => c.classList.remove('selected')); card.classList.add('selected'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            showPlaceDetail(place);
        });
        fullscreenMarkers.push(marker);
        bounds.extend(place.geometry.location);
    });
    if (places.length > 0) { fullscreenMap.fitBounds(bounds); if (places.length === 1) fullscreenMap.setZoom(15); }
}

function selectPlaceOnMap(place) { fullscreenMap.panTo(place.geometry.location); fullscreenMap.setZoom(15); }
function showPlaceDetail(place) {
    const modal = document.getElementById('place-detail-modal'), overlay = document.getElementById('modal-overlay');
    document.getElementById('place-name').textContent = place.name;
    const detailsContainer = document.getElementById('place-details');
    detailsContainer.innerHTML = `<div class="loading-container"><div class="spinner"></div><span>상세 정보 로딩 중...</span></div>`;
    modal.classList.add('active'); overlay.classList.add('active');
    placesService.getDetails({
        placeId: place.place_id, fields: ['name', 'formatted_address', 'formatted_phone_number', 'website', 'rating', 'user_ratings_total', 'reviews', 'photos', 'types', 'url'], language: 'ko'
    }, (detail, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && detail) { displayPlaceDetail(detail); } 
        else { detailsContainer.innerHTML = '<div class="text-center text-gray-500 py-4">상세 정보를 불러올 수 없습니다.</div>'; }
    });
}

function displayPlaceDetail(place) {
    let html = `<div class="space-y-4"><div class="border-b pb-4"><div class="flex items-center justify-between mb-2"><div class="flex items-center"><span class="text-yellow-500 mr-1">⭐</span><span class="font-bold">${place.rating||'N/A'}</span><span class="text-gray-500 ml-2">(${place.user_ratings_total||0} 리뷰)</span></div></div><p class="text-sm text-gray-600 mb-2">${place.formatted_address||''}</p>${place.formatted_phone_number?`<p class="text-sm text-blue-600">📞 ${place.formatted_phone_number}</p>`:''}${place.website?`<a href="${place.website}" target="_blank" class="text-sm text-blue-600 hover:underline">🌐 웹사이트</a>`:''}</div>`;
    if (place.types) html += `<div class="border-b pb-4"><h4 class="font-bold mb-2">📋 카테고리</h4><div class="flex flex-wrap gap-2">${place.types.map(t=>`<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${t}</span>`).join('')}</div></div>`;
    if (place.photos) html += `<div class="border-b pb-4"><h4 class="font-bold mb-2">📸 사진</h4><div class="grid grid-cols-2 gap-2">${place.photos.slice(0,4).map(p=>`<img src="${p.getUrl({maxWidth:200,maxHeight:150})}" class="w-full h-24 object-cover rounded-lg" onclick="window.open('${p.getUrl()}','_blank')">`).join('')}</div></div>`;
    if (place.reviews) html += `<div class="border-b pb-4"><h4 class="font-bold mb-2">💬 최근 리뷰</h4><div class="space-y-3 max-h-64 overflow-y-auto pr-2">${place.reviews.slice(0,10).map(r=>`<div class="bg-gray-50 p-3 rounded-lg"><div class="flex items-center justify-between mb-2"><div class="flex items-center"><span class="font-semibold text-sm">${r.author_name}</span><span class="ml-2 text-yellow-500">${'⭐'.repeat(r.rating)}</span></div><span class="text-xs text-gray-500">${r.relative_time_description}</span></div><p class="text-sm text-gray-700">${r.text}</p></div>`).join('')}</div></div>`;
    html += `<div class="flex space-x-2"><a href="${place.url}" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm"><i class="fab fa-google mr-2"></i>구글맵에서 보기</a><button onclick="alert('일정 추가 기능은 준비 중입니다.')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition text-sm"><i class="fas fa-plus mr-2"></i>일정에 추가</button></div>`;
    document.getElementById('place-details').innerHTML = html + `</div>`;
}

function clearFullscreenMarkers(includeUserMarker = true) {
    fullscreenMarkers.forEach(marker => marker.setMap(null)); fullscreenMarkers = [];
    if (includeUserMarker && fullscreenUserMarker) { fullscreenUserMarker.setMap(null); fullscreenUserMarker = null; }
}
function closeFullscreenModal() {
    document.getElementById('fullscreen-modal').classList.remove('active'); clearFullscreenMarkers(); allThemeResults = [];
    document.getElementById('theme-keyword-search').value = ''; document.getElementById('theme-category-filter').value = 'all'; document.getElementById('theme-sort-order').value = 'score';
}
function closeDetailModal() {
    document.getElementById('place-detail-modal').classList.remove('active'); document.getElementById('modal-overlay').classList.remove('active');
}


// --- 메인 플래너 관련 함수 ---
function switchDay(day) {
    activeDay = day;
    document.querySelectorAll('.day-tab').forEach(tab => {
        const tabDay = parseInt(tab.dataset.day);
        tab.classList.toggle('active', tabDay === day); tab.classList.toggle('bg-gray-200', tabDay !== day); tab.classList.toggle('text-gray-600', tabDay !== day);
    });
    document.querySelectorAll('.day-content').forEach(content => { content.classList.toggle('hidden', parseInt(content.id.replace('day', '')) !== day); });
    updateMapForDay(day); updateSelectedItemsDisplay();
}

async function handleOptionSelect(day, time, cardElement) {
    const grid = cardElement.parentElement;
    const isAlreadySelected = cardElement.classList.contains('selected');
    
    const existingDetailsPanel = document.querySelector('.details-panel');
    if (existingDetailsPanel) { existingDetailsPanel.remove(); }

    grid.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));

    if (isAlreadySelected) { delete selections[day][time]; updateAllDisplays(); return; }

    cardElement.classList.add('selected');
    
    const optionData = {
        id: cardElement.dataset.id, name: cardElement.dataset.name, cost: parseInt(cardElement.dataset.cost), type: cardElement.dataset.type, 
        lat: parseFloat(cardElement.dataset.lat), lng: parseFloat(cardElement.dataset.lng), menu: JSON.parse(cardElement.dataset.menu || 'null')
    };
    selections[day][time] = optionData;
    
    showDetailsPanel(cardElement, optionData);

    const allTimes = Object.keys(itineraryData[`day${day}`].slots);
    const currentIndex = allTimes.indexOf(time);
    if (currentIndex < allTimes.length - 1) {
        const nextTime = allTimes[currentIndex + 1];
        const nextSlot = itineraryData[`day${day}`].slots[nextTime];
        if (nextSlot) {
            delete selections[day][nextTime]; // 다음 슬롯 초기화
            const currentLoc = { lat: optionData.lat, lng: optionData.lng };
            if (nextSlot.dynamicSearch) await performNearbySearch(day, nextTime, currentLoc, nextSlot.dynamicSearch);
            if (nextSlot.jejuPassSearch) await performJejuPassSearch(day, nextTime, currentLoc, nextSlot.jejuPassSearch);
        }
    }
    updateAllDisplays();
}

function showDetailsPanel(cardElement, optionData) {
    const detailsPanel = document.createElement('div');
    detailsPanel.className = 'details-panel col-span-1 md:col-span-2 bg-gray-50 p-3 rounded-lg border';
    cardElement.parentElement.appendChild(detailsPanel);
    
    const hasMenu = optionData.menu && optionData.menu.length > 0;
    detailsPanel.innerHTML = `<div class="flex border-b mb-2 text-xs font-semibold text-gray-500">${hasMenu ? `<div class="details-tab active" data-tab="menu">대표 메뉴</div>` : ''}<div class="details-tab ${!hasMenu ? 'active' : ''}" data-tab="reviews">실시간 리뷰/정보</div></div><div class="details-content ${hasMenu ? 'active' : ''}" data-content="menu"></div><div class="details-content ${!hasMenu ? 'active' : ''}" data-content="reviews"></div>`;
    if (hasMenu) { detailsPanel.querySelector('[data-content="menu"]').innerHTML = generateMenuHtml(optionData.menu); }
    
    fetchLiveReviews(detailsPanel.querySelector('[data-content="reviews"]'), optionData);

    detailsPanel.querySelectorAll('.details-tab').forEach(tab => {
        tab.onclick = (e) => {
            e.stopPropagation();
            detailsPanel.querySelectorAll('.details-tab, .details-content').forEach(el => el.classList.remove('active'));
            tab.classList.add('active'); detailsPanel.querySelector(`[data-content="${tab.dataset.tab}"]`).classList.add('active');
            detailsPanel.style.height = detailsPanel.scrollHeight + 'px';
        };
    });
    requestAnimationFrame(() => { detailsPanel.classList.add('open'); detailsPanel.style.height = detailsPanel.scrollHeight + 'px'; });
}

function generateMenuHtml(menu) {
    const displayMenu = menu.slice(0, 5); const familyPrice = displayMenu.reduce((sum, item) => sum + item.price, 0) * 1.3;
    let html = displayMenu.map(item => `<div class="flex justify-between items-center text-xs py-1 border-b border-gray-200 last:border-b-0"><span class="text-gray-700">${item.item}</span><span class="font-semibold">₩${item.price.toLocaleString()}</span></div>`).join('');
    html += `<div class="mt-2 text-right text-xs font-bold text-blue-600">4인 예상: ₩${(Math.ceil(familyPrice / 1000) * 1000).toLocaleString()}</div>`; return html;
}

// 리뷰/정보 가져오기 (제주패스 장소 로직 추가)
function fetchLiveReviews(container, optionData) {
    container.innerHTML = `<div class="loading-container"><div class="spinner"></div><span class="text-xs">실시간 정보 로딩 중...</span></div>`;
    if (!placesService) { container.innerHTML = '<p class="text-center text-xs text-gray-500 py-2">리뷰 서비스를 사용할 수 없습니다.</p>'; return; }

    const getDetailsCallback = (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place) {
            let reviewHtml = '<p class="text-center text-xs text-gray-500 py-2">리뷰 정보가 없습니다.</p>';
            if (place.reviews) {
                reviewHtml = place.reviews.slice(0, 3).map(review => `<div class="bg-gray-100 p-2 rounded-md mb-2"><p class="text-xs text-gray-700">${review.text.substring(0, 80)}...</p><div class="text-right text-xs mt-1 text-gray-500">${'⭐'.repeat(review.rating)} by ${review.author_name}</div></div>`).join('');
            }
            container.innerHTML = `<div class="space-y-2"><div class="flex items-center justify-between text-xs"><span class="font-semibold">평점: ⭐ ${place.rating || 'N/A'}/5.0</span><span class="text-gray-500">(${place.user_ratings_total || 0} 리뷰)</span></div>${reviewHtml}<a href="${place.url}" target="_blank" onclick="event.stopPropagation()" class="block w-full text-center mt-2 bg-gray-200 text-gray-700 font-semibold py-1 rounded text-xs hover:bg-gray-300 transition"><i class="fab fa-google mr-1"></i>구글맵에서 더 보기</a></div>`;
        } else {
            container.innerHTML = '<p class="text-center text-xs text-gray-500 py-2">장소 정보를 불러올 수 없습니다.</p>';
        }
        const panel = container.closest('.details-panel');
        if (panel && panel.classList.contains('open')) panel.style.height = panel.scrollHeight + 'px';
    };

    // 제주패스 또는 기타 ID 기반 장소 처리
    if (optionData.id.startsWith('jp_') || (optionData.name && optionData.lat)) {
        placesService.findPlaceFromQuery({
            query: optionData.name, locationBias: { lat: optionData.lat, lng: optionData.lng }, fields: ['place_id']
        }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
                placesService.getDetails({ placeId: results[0].place_id, fields: ['rating', 'user_ratings_total', 'reviews', 'url'], language: 'ko' }, getDetailsCallback);
            } else {
                getDetailsCallback(null, status);
            }
        });
    } 
    // 기존 Google Place ID 기반 장소 처리
    else if (!optionData.id.startsWith('static_') && optionData.id) {
        placesService.getDetails({ placeId: optionData.id, fields: ['rating', 'user_ratings_total', 'reviews', 'url'], language: 'ko' }, getDetailsCallback);
    } 
    // 리뷰를 가져올 수 없는 경우 (공항 등)
    else {
        container.innerHTML = '<p class="text-center text-xs text-gray-500 py-2">이 장소는 리뷰가 제공되지 않습니다.</p>';
    }
}

// 제주패스 장소 검색 함수
async function performJejuPassSearch(day, time, location, searchConfig) {
    const grid = document.querySelector(`.options-grid[data-day="${day}"][data-time="${time}"]`);
    grid.innerHTML = `<div class="loading-container"><div class="spinner"></div><span class="text-xs">근처 PASS 가맹점 검색 중...</span></div>`;
    
    const startPoint = new google.maps.LatLng(location.lat, location.lng);
    const nearbyPlaces = jejuPassData
        .map(place => ({
            ...place,
            distance: google.maps.geometry.spherical.computeDistanceBetween(startPoint, new google.maps.LatLng(place.lat, place.lng))
        }))
        .filter(place => place.distance <= searchConfig.radius)
        .sort((a, b) => a.distance - b.distance)
        .slice(0, searchConfig.minResults);

    if(nearbyPlaces.length > 0) {
        const options = {};
        nearbyPlaces.forEach(place => { options[place.id] = place; });
        grid.innerHTML = generateOptionsHtml(day, time, options);
    } else {
        grid.innerHTML = `<div class="loading-container text-red-500 text-xs">근처 ${searchConfig.radius/1000}km 내에 PASS 가맹점이 없습니다.</div>`;
    }
}

// Google Places API 기반 검색 함수
async function performNearbySearch(day, time, location, searchConfig) {
    const grid = document.querySelector(`.options-grid[data-day="${day}"][data-time="${time}"]`);
    grid.innerHTML = `<div class="loading-container"><div class="spinner"></div><span class="text-xs">${searchConfig.type==='food' ? '맛집' : '카페'} 검색 중...</span></div>`;
    return new Promise((resolve) => {
        if (!placesService) { resolve(); return; }
        placesService.nearbySearch({
            location: new google.maps.LatLng(location.lat, location.lng), radius: searchConfig.radius, keyword: `제주 ${searchConfig.keywords.join(' OR ')}`, language: 'ko'
        }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                const filtered = results.filter(p => p.rating && p.user_ratings_total > 20 && p.rating >= 3.8 && p.business_status === 'OPERATIONAL').sort((a,b) => b.rating - a.rating).slice(0, searchConfig.minResults);
                const options = {};
                filtered.forEach(place => {
                    options[place.place_id] = { id: place.place_id, name: place.name, cost: estimateDynamicCost(searchConfig.type), type: searchConfig.type, tags: [`⭐ ${place.rating}`, `${place.user_ratings_total} 리뷰`], lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                });
                grid.innerHTML = generateOptionsHtml(day, time, options);
            } else { grid.innerHTML = `<div class="loading-container text-red-500 text-xs">검색 결과가 없습니다.</div>`; }
            resolve();
        });
    });
}

function generateOptionsHtml(day, time, options) {
    let html = '';
    Object.entries(options).forEach(([id, opt]) => {
        html += `<div class="option-card border-gray-200 rounded-lg p-3 cursor-pointer" data-id="${opt.id}" data-name="${opt.name}" data-cost="${opt.cost}" data-type="${opt.type}" data-lat="${opt.lat}" data-lng="${opt.lng}" data-menu='${JSON.stringify(opt.menu || null)}'><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-gray-800 text-sm pr-2">${opt.name}</h4><span class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded-full whitespace-nowrap">₩${opt.cost.toLocaleString()}</span></div><div class="flex flex-wrap gap-1 mt-2">${(opt.tags || []).map(tag => `<span class="text-xs font-semibold ${tag.startsWith('⭐') ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-700'} px-2 py-1 rounded-full">${tag}</span>`).join('')}</div></div>`;
    }); return html;
}

function estimateDynamicCost(type) {
    if (type === 'food') return Math.floor(Math.random() * 30000) + 70000;
    if (type === 'cafe') return Math.floor(Math.random() * 15000) + 25000;
    return Math.floor(Math.random() * 20000) + 10000;
}

function resetToOriginal() { if (confirm('원래 계획된 일정으로 되돌리시겠습니까?')) { selections = JSON.parse(JSON.stringify(originalSelections)); initUI(); switchDay(activeDay); } }
function updateAllDisplays() { updateCostDisplay(); updateSelectedItemsDisplay(); updateMapForDay(activeDay); }

function updateCostDisplay() {
    const costs = { food: 0, activity: 0, etc: 0 };
    Object.values(selections).forEach(daySels => {
        if(daySels) Object.values(daySels).forEach(sel => { if (sel && sel.type !== 'accommodation' && costs.hasOwnProperty(sel.type)) { costs[sel.type] += sel.cost; } });
    });
    Object.keys(costs).forEach(key => { const e = document.getElementById(`cost-${key}`); if (e) e.textContent = `₩${costs[key].toLocaleString()}`; });
    const total = Object.values(costs).reduce((a, b) => a + b, 0) + fixedCosts.flight + fixedCosts.hotel;
    document.getElementById('total-cost').textContent = `₩${total.toLocaleString()}`;
}

function updateSelectedItemsDisplay() {
    const container = document.getElementById('selected-items-container'); container.innerHTML = '';
    const daySelections = selections[activeDay] || {}; const sortedTimes = Object.keys(daySelections).sort();
    if(sortedTimes.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 py-3 text-xs">선택된 일정이 없습니다.</p>'; return; }
    const list = document.createElement('div'); list.className = 'space-y-2 text-xs';
    sortedTimes.forEach(time => { const sel = daySelections[time]; if (sel && sel.type !== 'accommodation') { list.innerHTML += `<div class="flex items-center"><span class="font-semibold text-blue-600 w-12">${time}</span><span class="flex-grow text-gray-700">${sel.name}</span><span class="font-semibold text-gray-800 text-right">₩${sel.cost.toLocaleString()}</span></div>`; } });
    container.appendChild(list);
}

function updateMapForDay(day) {
    if (!googleMap || !directionsRenderer) return;
    const daySelections = Object.values(selections[day] || {}).filter(s => s && s.lat && s.lng);
    daySelections.sort((a,b) => {
        const tA = Object.keys(selections[day]).find(k=>selections[day][k]&&selections[day][k].id===a.id), tB = Object.keys(selections[day]).find(k=>selections[day][k]&&selections[day][k].id===b.id);
        if(!tA||!tB) return 0; return tA.localeCompare(tB);
    });
    directionsRenderer.setDirections({routes: []}); if (window.dayMarkers) window.dayMarkers.forEach(m => m.setMap(null)); window.dayMarkers = [];
    if(daySelections.length === 0) { googleMap.setCenter({ lat: 33.385, lng: 126.55 }); googleMap.setZoom(9); return; };
    const bounds = new google.maps.LatLngBounds();
    daySelections.forEach((sel, index) => {
        const pos = { lat: sel.lat, lng: sel.lng }; bounds.extend(pos);
        const marker = new google.maps.Marker({ position: pos, map: googleMap, label: { text: `${index + 1}`, color: 'white', fontWeight: 'bold' }, title: sel.name }); window.dayMarkers.push(marker);
    });
    if (daySelections.length > 1) {
        const request = { origin: { lat: daySelections[0].lat, lng: daySelections[0].lng }, destination: { lat: daySelections[daySelections.length-1].lat, lng: daySelections[daySelections.length-1].lng }, waypoints: daySelections.slice(1, -1).map(s => ({ location: { lat: s.lat, lng: s.lng } })), travelMode: 'DRIVING' };
        directionsService.route(request, (result, status) => { if (status === 'OK') directionsRenderer.setDirections(result); });
    }
    if (userLocationMarker) bounds.extend(userLocationMarker.getPosition());
    googleMap.fitBounds(bounds); if(daySelections.length === 1 && !userLocationMarker) googleMap.setZoom(14);
}

function toggleNaviMode() {
    const btn = document.getElementById('navi-mode-toggle'); isNaviModeActive = !isNaviModeActive;
    if (isNaviModeActive) {
        if (navigator.geolocation) { btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>GPS 연결 중...`; watchId = navigator.geolocation.watchPosition(handleLocationUpdate, handleLocationError, { enableHighAccuracy: true }); } 
        else { alert("이 브라우저는 위치 정보를 지원하지 않습니다."); isNaviModeActive = false; }
    } else {
        if (watchId !== null) navigator.geolocation.clearWatch(watchId); watchId = null;
        if (userLocationMarker) userLocationMarker.setMap(null); userLocationMarker = null;
        btn.innerHTML = `<i class="fas fa-location-arrow mr-2"></i>Live GPS`; document.querySelectorAll('.distance-info').forEach(el => el.innerHTML = '');
    }
}

function handleLocationUpdate(position) {
    const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
    document.getElementById('navi-mode-toggle').innerHTML = `<i class="fas fa-location-arrow mr-2"></i>GPS 연결됨`;
    if (!userLocationMarker) { userLocationMarker = new google.maps.Marker({ position: userLocation, map: googleMap, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 }, title: "현재 내 위치" }); } 
    else { userLocationMarker.setPosition(userLocation); }
    updateDistances(userLocation);
}

function handleLocationError(error) { alert(`위치 정보를 가져올 수 없습니다: ${error.message}`); toggleNaviMode(); }

function updateDistances(userLocation) {
    const daySels = selections[activeDay] || {}; const sortedTimes = Object.keys(daySels).sort();
    const now = new Date(); const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    const nextTime = sortedTimes.find(time => time > currentTimeStr);
    if (nextTime) {
        const nextDest = daySels[nextTime];
        if (nextDest) {
            directionsService.route({ origin: userLocation, destination: { lat: nextDest.lat, lng: nextDest.lng }, travelMode: 'DRIVING' }, (result, status) => {
                if (status === 'OK') {
                    const leg = result.routes[0].legs[0]; document.querySelectorAll('.distance-info').forEach(el => el.innerHTML = '');
                    const distEl = document.querySelector(`.distance-info[data-day="${activeDay}"][data-time="${nextTime}"]`);
                    if (distEl) distEl.innerHTML = `📍 다음 목적지까지 ${leg.distance.text}, ${leg.duration.text}`;
                }
            });
        }
    }
}

function openInGoogleMaps() {
    const daySels = Object.values(selections[activeDay] || {}).filter(s => s && s.lat);
    daySels.sort((a,b) => { const tA = Object.keys(selections[activeDay]).find(k=>selections[activeDay][k].id===a.id), tB = Object.keys(selections[activeDay]).find(k=>selections[activeDay][k].id===b.id); return tA.localeCompare(tB); });
    if(daySels.length < 1) { alert("먼저 장소를 선택해주세요."); return; }
    let url = 'https://www.google.com/maps/dir/';
    if (userLocationMarker) { const pos = userLocationMarker.getPosition(); url += `${pos.lat()},${pos.lng()}/`; }
    daySels.forEach(sel => { url += `${sel.lat},${sel.lng}/`; }); window.open(url, '_blank');
}

window.addEventListener('load', () => { if (typeof google === 'undefined') { setTimeout(initApp, 1000); } });
</script>
</body>
</html>
