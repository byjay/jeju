<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°•ê·€ì„ ë‹˜ì„ ìœ„í•œ ì œì£¼ì—¬í–‰ í”Œë˜ë„ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <!-- ì¤‘ìš”: geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOAEMIvJc9VndXLYgmUnWoAuXjlOYzDtg&callback=initApp&libraries=places,directions,geometry&v=weekly" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Noto Sans KR', sans-serif; box-sizing: border-box; }
        
        :root {
            --primary-blue: #3b82f6;
            --primary-purple: #7c3aed;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
        }

        /* === ì „ì²´ ë ˆì´ì•„ì›ƒ === */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ì€ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ */
            background-color: #f3f4f6;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
        }

        /* === ìƒë‹¨ ì§€ë„ ì˜ì—­ === */
        #map-area {
            flex-shrink: 0;
            position: relative;
            height: 40vh; /* í™”ë©´ì˜ 40%ë¥¼ ì§€ë„ë¡œ ì‚¬ìš© */
            background-color: #e5e7eb;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* === í•˜ë‹¨ ì½˜í…ì¸  ì˜ì—­ === */
        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* === ê³ ì • ì»¨íŠ¸ë¡¤ íŒ¨ë„ === */
        .control-panel {
            flex-shrink: 0;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-tabs-container {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .day-tabs-container::-webkit-scrollbar { display: none; }
        .day-tab {
            transition: all 0.2s ease;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            flex-shrink: 0;
            margin: 0 0.25rem;
            cursor: pointer;
        }
        .day-tab.active {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-purple) 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .day-tab:not(.active) { background: #e5e7eb; color: #374151; }

        /* === ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì¼ì • ì˜ì—­ === */
        .itinerary-scroll-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
        
        /* === ëª¨ë°”ì¼ ìµœì í™” ì˜µì…˜ ì¹´ë“œ === */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* í•­ìƒ 2ì—´ ìœ ì§€ */
            gap: 0.75rem;
        }
        .option-card {
            transition: all 0.2s ease;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            background: white;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        .option-card.selected {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            transform: scale(1.02);
        }
        .option-card .card-name { font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem; line-height: 1.3; }
        .option-card .card-tags { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; }
        .option-card .tag { font-size: 0.65rem; padding: 0.125rem 0.5rem; border-radius: 10px; }
        
        /* === ìƒì„¸ ì •ë³´ íŒ¨ë„ (ë©”ë‰´/ë¦¬ë·°) === */
        .menu-panel {
            background: #f8fafc;
            border-radius: 12px;
            margin-top: 0.75rem;
            border: 1px solid #e2e8f0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease;
            opacity: 0;
            padding: 0 0.75rem;
        }
        .menu-panel.open { max-height: 500px; opacity: 1; padding: 0.75rem; }
        .menu-tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 0.75rem; }
        .menu-tab { padding: 0.5rem; font-size: 0.875rem; cursor: pointer; border-bottom: 3px solid transparent; }
        .menu-tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); font-weight: 600; }
        .menu-content { display: none; }
        .menu-content.active { display: block; }
        .menu-item { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.8rem; border-bottom: 1px solid #e5e7eb; }

        /* === ì‹¤ì‹œê°„ ì •ë³´ UI === */
        .distance-info { color: var(--success-green); font-size: 0.8rem; font-weight: 600; }
        .loading-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .live-next-item .option-card.selected {
             border-color: var(--warning-orange);
             background-color: #fffbeb;
        }
        .next-badge {
            background: var(--warning-orange);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .hidden { display: none !important; }

        /* íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ */
        .timeline-container { position: relative; padding-left: 1rem; }
        .timeline-line { position: absolute; left: 0.3rem; top: 0.5rem; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary-blue) 0%, var(--primary-purple) 100%); }
        .timeline-dot { position: absolute; left: -2px; top: 0.5rem; width: 14px; height: 14px; background: var(--primary-blue); border: 3px solid white; border-radius: 50%; z-index: 2; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ìƒë‹¨ ê³ ì • ì§€ë„ ì˜ì—­ -->
        <div id="map-area">
            <div id="map"></div>
        </div>

        <!-- í•˜ë‹¨ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
            <!-- ê³ ì • ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
            <div class="control-panel">
                <div class="day-tabs-container" id="day-tabs-container">
                    <!-- íƒ­ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì¼ì • ì˜ì—­ -->
            <div class="itinerary-scroll-wrapper">
                <div id="itinerary-container">
                    <!-- ì¼ì •ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

<script>
// --- ë°ì´í„°ë² ì´ìŠ¤ì™€ ì¼ì • ë°ì´í„° ---
const jejuDatabase = {
    restaurants: {
        dongmun_market: {
            id: 'dongmun_market', name: 'ë™ë¬¸ì‹œì¥ ì•¼ì‹œì¥', rating: 4.2, reviewCount: 2847, cost: 30000, type: 'food',
            lat: 33.5126, lng: 126.5292, tags: ['ì‹œì¥', 'ì•¼ì‹'],
            menu: [ {item: 'ëª¨ë‘ íšŒ(ì†Œ)', price: 20000}, {item: 'í‘ë¼ì§€ê¼¬ì¹˜', price: 5000}, {item: 'ì˜¤ë©”ê¸°ë–¡', price: 5000} ],
            reviews: [ {author: 'ê¹€ì œì£¼', rating: 5, text: 'ë™ë¬¸ì‹œì¥ì€ ì œì£¼ ì—¬í–‰ì˜ í•„ìˆ˜ì½”ìŠ¤!'}, {author: 'ë°•ì—¬í–‰', rating: 4, text: 'ê°€ê²©ë„ ì €ë ´í•˜ê³  ì–‘ë„ ë§ì•„ìš”.'} ]
        },
        dombedon: {
            id: 'dombedon', name: 'ë”ë² ëˆ', rating: 4.6, reviewCount: 1247, cost: 130000, type: 'food',
            lat: 33.5148, lng: 126.5245, tags: ['í‘ë¼ì§€', 'í˜„ì§€ë§›ì§‘'],
            menu: [ {item: 'í‘ë¼ì§€ ëª©ì‚´', price: 28000}, {item: 'ê°ˆë§¤ê¸°ì‚´', price: 32000} ],
            reviews: [ {author: 'ê³ ê¸°ì™•', rating: 5, text: 'ì œì£¼ í‘ë¼ì§€ì˜ ì§„ì§œ ë§›ì„ ëŠë‚„ ìˆ˜ ìˆëŠ” ê³³!'} ]
        },
        jamaeguksu: {
            id: 'jamaeguksu', name: 'ìë§¤êµ­ìˆ˜ ë³¸ì ', rating: 4.5, reviewCount: 2891, cost: 45000, type: 'food',
            lat: 33.5111, lng: 126.5284, tags: ['ê³ ê¸°êµ­ìˆ˜', 'í–¥í† ìŒì‹'],
            menu: [{item: 'ê³ ê¸°êµ­ìˆ˜', price: 8000}, {item: 'ë¹„ë¹”êµ­ìˆ˜', price: 8000}],
            reviews: [{author: 'êµ­ìˆ˜ì¡°ì•„', rating: 5, text: 'ì§„ì§œ ì œì£¼ ë§›ì§‘! ê³ ê¸°êµ­ìˆ˜ êµ­ë¬¼ì´ ëë‚´ì¤ë‹ˆë‹¤.'}]
        }
    },
    cafes: {
        cafe_orda: {
            id: 'cafe_orda', name: 'ì¹´í˜ ì˜¤ë¥´ë‹¤', rating: 4.7, reviewCount: 1856, cost: 35000, type: 'cafe',
            lat: 33.4475, lng: 126.9323, tags: ['í¬í† ì¡´', 'ì˜¤ì…˜ë·°'],
            menu: [ {item: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 5500}, {item: 'í‘ì„ìë¼ë–¼', price: 6500} ],
            reviews: [ {author: 'ì¹´í˜ëŸ¬ë²„', rating: 5, text: 'ì²œêµ­ì˜ ê³„ë‹¨ìœ¼ë¡œ ìœ ëª…í•œ ê³³!'} ]
        }
    },
    attractions: {
        seongsan: {
            id: 'seongsan', name: 'ì„±ì‚°ì¼ì¶œë´‰', rating: 4.5, reviewCount: 5247, cost: 5000, type: 'activity',
            lat: 33.4581, lng: 126.9426, tags: ['ìœ ë„¤ìŠ¤ì½”', 'ì¼ì¶œ'],
            menu: [ {item: 'ì„±ì¸ ì…ì¥ë£Œ', price: 5000} ],
            reviews: [ {author: 'ì¼ì¶œëŸ¬ë²„', rating: 5, text: 'ì œì£¼ ì—¬í–‰ 1ìˆœìœ„! ì¼ì¶œ ì‹œê°„ì— ë§ì¶° ê°€ì‹œê¸¸ ê°•ì¶”í•©ë‹ˆë‹¤.'} ]
        },
        aquaplanet: {
            id: 'aquaplanet', name: 'ì•„ì¿ ì•„í”Œë¼ë„· ì œì£¼', rating: 4.4, reviewCount: 3892, cost: 120000, type: 'activity',
            lat: 33.4320, lng: 126.9248, tags: ['ìˆ˜ì¡±ê´€', 'ì‹¤ë‚´'],
            menu: [ {item: 'ì„±ì¸ ì…ì¥ê¶Œ', price: 38000} ],
            reviews: [ {author: 'ê°€ì¡±ë‚˜ë“¤ì´', rating: 5, text: 'ì•„ì´ë“¤ì´ ì •ë§ ì¢‹ì•„í•´ìš”!'} ]
        }
    }
};
const itineraryData = {
    day1: {
        title: "ì œì£¼ ë„ì°© & ì„¤ë ˆëŠ” ì²«ë‚  ë°¤",
        slots: {
            '18:00': { icon: 'âœˆï¸', category: 'ê³µí•­ ë„ì°©', options: { arrival: { id: 'arrival', name: 'ì œì£¼êµ­ì œê³µí•­', cost: 0, type: 'etc', tags: ['í•„ìˆ˜'], lat: 33.5104, lng: 126.4913 } } },
            '19:00': { icon: 'ğŸ¨', category: 'ìˆ™ì†Œ ì²´í¬ì¸', options: { checkin_hotel: { id: 'checkin_hotel', name: 'ì²´í¬ì¸í˜¸í…” ì œì£¼', cost: 0, type: 'accommodation', tags: ['ìˆ™ì†Œ'], lat: 33.5015, lng: 126.5050 } } },
            '19:30': { icon: 'ğŸ´', category: 'ì €ë… ì‹ì‚¬', options: { dongmun_market: jejuDatabase.restaurants.dongmun_market, dombedon: jejuDatabase.restaurants.dombedon, jamaeguksu: jejuDatabase.restaurants.jamaeguksu } },
            '21:00': { icon: 'ğŸŒ™', category: 'ì•¼ê°„ í™œë™', options: { night_walk: { id: 'night_walk', name: 'ì´í˜¸í…Œìš° í•´ë³€', rating: 4.2, cost: 10000, type: 'etc', lat: 33.5127, lng: 126.4528, tags: ['ì•¼ê²½', 'ì‚°ì±…'] } } }
        }
    },
    day2: {
        title: "í™˜ìƒì˜ ë™ìª½ í•´ì•ˆë„ë¡œ",
        slots: {
            '10:30': { icon: 'ğŸï¸', category: 'ì˜¤ì „ í™œë™', options: { seongsan: jejuDatabase.attractions.seongsan } },
            '15:00': { icon: 'â˜•', category: 'ì¹´í˜ íƒ€ì„', options: { cafe_orda: jejuDatabase.cafes.cafe_orda } },
            '16:30': { icon: 'ğŸŒŠ', category: 'ì˜¤í›„ í™œë™', options: { aquaplanet: jejuDatabase.attractions.aquaplanet } }
        }
    },
    // ... (day3, day4 ë°ì´í„°ëŠ” ê°„ê²°í•¨ì„ ìœ„í•´ ìƒëµ, ì‹¤ì œ ì‚¬ìš©ì‹œ ì¶”ê°€)
};

// ì „ì—­ ë³€ìˆ˜
let googleMap, directionsService, directionsRenderer;
let activeDay = 1;
let selections = {};
let originalSelections = {};
let isNaviModeActive = false;
let watchId = null;
let userLocationMarker = null;
let dayMarkers = [];
// !!! ì¤‘ìš”: ì‹¤ì œ ì—¬í–‰ ì‹œì‘ì¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš” !!!
const tripStartDate = new Date('2024-07-25'); 

function initApp() {
    initUI();
    initMap();
    setupEventListeners();
    setupInitialState();
    autoSelectToday();
}

function autoSelectToday() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startDate = new Date(tripStartDate.valueOf());
    startDate.setHours(0, 0, 0, 0);
    const diffTime = today - startDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    if (diffDays >= 1 && diffDays <= Object.keys(itineraryData).length) {
        switchDay(diffDays);
    }
}

function initUI() {
    const tabsContainer = document.getElementById('day-tabs-container');
    const itineraryContainer = document.getElementById('itinerary-container');
    
    Object.keys(itineraryData).forEach((dayKey, index) => {
        const day = parseInt(dayKey.replace('day', ''));
        const tab = document.createElement('button');
        tab.className = `day-tab ${index === 0 ? 'active' : ''}`;
        tab.textContent = `${day}ì¼ì°¨`;
        tab.dataset.day = day;
        tabsContainer.appendChild(tab);
    });

    Object.keys(itineraryData).forEach((dayKey, index) => {
        const day = parseInt(dayKey.replace('day', ''));
        const dayData = itineraryData[dayKey];
        
        const dayContent = document.createElement('div');
        dayContent.id = `day${day}`;
        dayContent.className = `day-content ${index > 0 ? 'hidden' : ''}`;
        dayContent.innerHTML = `
            <div class="mb-4">
                <h2 class="text-xl font-bold text-gray-800">${dayData.title}</h2>
            </div>
            <div class="timeline-container">
                <div class="timeline-line"></div>
                ${Object.entries(dayData.slots).map(([time, slot]) => `
                    <div class="relative mb-6" data-timeslot-wrapper="${time}">
                        <div class="timeline-dot"></div>
                        <div class="ml-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="text-sm font-bold text-gray-700 mr-2">${time}</span>
                                    <h3 class="text-base font-semibold text-gray-800">${slot.icon} ${slot.category}</h3>
                                </div>
                                <div class="next-badge-container"></div>
                            </div>
                            <div class="distance-info mb-2" data-day="${day}" data-time="${time}"></div>
                            <div class="options-grid" data-day="${day}" data-time="${time}">
                                ${slot.options ? generateOptionsHtml(day, time, slot.options) : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        itineraryContainer.appendChild(dayContent);
    });
}

function generateOptionsHtml(day, time, options) {
    return Object.entries(options).map(([id, option]) => `
        <div class="option-card" 
             data-id="${id}" 
             data-lat="${option.lat}" 
             data-lng="${option.lng}" 
             onclick="handleOptionSelect(${day}, '${time}', this)">
            <p class="card-name">${option.name}</p>
            <div class="card-tags">
                ${(option.tags || []).slice(0, 2).map(tag => `<span class="tag ${getTagColorClass(tag)}">${tag}</span>`).join('')}
            </div>
        </div>
    `).join('');
}

function getTagColorClass(tag) {
    const colorMap = {
        'í•„ìˆ˜': 'bg-red-100 text-red-700', 'ê°€ì„±ë¹„': 'bg-green-100 text-green-700', 'í¬í† ì¡´': 'bg-purple-100 text-purple-700',
        'ì˜¤ì…˜ë·°': 'bg-blue-100 text-blue-700', 'í–¥í† ìŒì‹': 'bg-orange-100 text-orange-700', 'ì‹¤ë‚´': 'bg-cyan-100 text-cyan-700',
        'ì‹œì¥': 'bg-yellow-100 text-yellow-700', 'ì•¼ì‹': 'bg-indigo-100 text-indigo-700', 'í‘ë¼ì§€': 'bg-gray-200 text-gray-800'
    };
    return colorMap[tag] || 'bg-gray-100 text-gray-700';
}

function initMap() {
    try {
        googleMap = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 33.385, lng: 126.55 }, zoom: 9,
            styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }],
            disableDefaultUI: true, zoomControl: true, mapTypeControl: false, streetViewControl: false
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#4f46e5', strokeWeight: 5, strokeOpacity: 0.8 } });
        directionsRenderer.setMap(googleMap);
    } catch (e) {
        document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-500">ì§€ë„ ë¡œë”© ì‹¤íŒ¨</div>';
    }
}

function setupEventListeners() {
    const tabsContainer = document.getElementById('day-tabs-container');
    tabsContainer.addEventListener('click', (e) => {
        const tab = e.target.closest('.day-tab');
        if (tab && tab.dataset.day) {
            switchDay(parseInt(tab.dataset.day));
        }
    });
}

function setupInitialState() {
    Object.keys(itineraryData).forEach(dayKey => {
        const day = parseInt(dayKey.replace('day', ''));
        selections[day] = {};
        Object.entries(itineraryData[dayKey].slots).forEach(([time, slot]) => {
            if (slot.options && Object.keys(slot.options).length > 0) {
                const firstOptionKey = Object.keys(slot.options)[0];
                selections[day][time] = { ...slot.options[firstOptionKey], id: firstOptionKey };
            }
        });
    });
    originalSelections = JSON.parse(JSON.stringify(selections));
    updateUISelections();
    updateMapForDay(activeDay);
}

function updateUISelections() {
    document.querySelectorAll('.option-card.selected').forEach(c => c.classList.remove('selected'));
    const daySelections = selections[activeDay] || {};
    Object.entries(daySelections).forEach(([time, selection]) => {
        if(selection && selection.id) {
            const card = document.querySelector(`.options-grid[data-day="${activeDay}"][data-time="${time}"] .option-card[data-id="${selection.id}"]`);
            if (card) {
                card.classList.add('selected');
            }
        }
    });
}

function switchDay(day) {
    activeDay = day;
    document.querySelectorAll('.day-tab').forEach(tab => {
        tab.classList.toggle('active', parseInt(tab.dataset.day) === day);
        if (parseInt(tab.dataset.day) === day) {
            tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }
    });
    document.querySelectorAll('.day-content').forEach(content => {
        content.classList.toggle('hidden', parseInt(content.id.replace('day', '')) !== day);
    });
    
    updateUISelections();
    updateMapForDay(day);

    if (isNaviModeActive && userLocationMarker) {
        updateLiveStatus(userLocationMarker.getPosition());
    } else {
        clearLiveStatus();
    }
}

function handleOptionSelect(day, time, cardElement) {
    const grid = cardElement.closest('.options-grid');
    grid.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
    cardElement.classList.add('selected');
    
    document.querySelectorAll('.menu-panel').forEach(p => p.remove());

    const id = cardElement.dataset.id;
    let optionData = findDetailData(id) || itineraryData[`day${day}`].slots[time].options[id];
    
    selections[day][time] = { ...optionData, id: id };
    
    updateMapForDay(day);
    if (isNaviModeActive && userLocationMarker) {
        updateLiveStatus(userLocationMarker.getPosition());
    }
    
    showMenuPanel(cardElement.parentElement, optionData);
}

function findDetailData(id) {
    for (const category of Object.values(jejuDatabase)) {
        if (category[id]) return category[id];
    }
    return null;
}

function showMenuPanel(gridElement, optionData) {
    const hasMenu = optionData.menu && optionData.menu.length > 0;
    const hasReviews = optionData.reviews && optionData.reviews.length > 0;
    
    const menuPanel = document.createElement('div');
    menuPanel.className = 'menu-panel';
    menuPanel.innerHTML = `
        <div class="menu-tabs">
            ${hasMenu ? '<div class="menu-tab active" data-tab="menu">ë©”ë‰´</div>' : ''}
            ${hasReviews ? `<div class="menu-tab ${!hasMenu ? 'active' : ''}" data-tab="reviews">ë¦¬ë·°</div>` : ''}
        </div>
        ${hasMenu ? `<div class="menu-content active" data-content="menu">${generateMenuContent(optionData.menu)}</div>` : ''}
        ${hasReviews ? `<div class="menu-content ${!hasMenu ? 'active' : ''}" data-content="reviews">${generateReviewContent(optionData.reviews)}</div>` : ''}
    `;
    
    menuPanel.querySelectorAll('.menu-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            menuPanel.querySelectorAll('.menu-tab, .menu-content').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            menuPanel.querySelector(`[data-content="${tab.dataset.tab}"]`).classList.add('active');
        });
    });
    
    gridElement.appendChild(menuPanel);
    setTimeout(() => {
        menuPanel.classList.add('open');
        menuPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 10);
}

function generateMenuContent(menu) {
    return `<div class="space-y-1">${menu.slice(0, 4).map(item => `
        <div class="menu-item"><span>${item.item}</span><span class="font-semibold">â‚©${item.price.toLocaleString()}</span></div>`).join('')}
    </div>`;
}

function generateReviewContent(reviews) {
    return `<div class="space-y-2">${reviews.slice(0, 2).map(review => `
        <div class="text-xs">
            <div class="flex justify-between items-center"><span class="font-semibold">${review.author}</span><span class="text-yellow-400">${'â˜…'.repeat(review.rating)}</span></div>
            <p class="text-gray-600">${review.text}</p>
        </div>`).join('')}
    </div>`;
}

function updateMapForDay(day) {
    if (!googleMap) return;
    
    dayMarkers.forEach(m => m.setMap(null));
    dayMarkers = [];
    directionsRenderer.setDirections({routes: []});
    
    const daySelections = Object.values(selections[day] || {}).filter(s => s && s.lat && s.lng);
    daySelections.sort((a, b) => {
        const timeA = Object.keys(selections[day]).find(key => selections[day][key]?.id === a.id);
        const timeB = Object.keys(selections[day]).find(key => selections[day][key]?.id === b.id);
        return timeA && timeB ? timeA.localeCompare(timeB) : 0;
    });

    if (daySelections.length === 0) return;

    const bounds = new google.maps.LatLngBounds();
    daySelections.forEach((sel, index) => {
        const pos = { lat: sel.lat, lng: sel.lng };
        bounds.extend(pos);
        const marker = new google.maps.Marker({
            position: pos, map: googleMap,
            label: { text: `${index + 1}`, color: 'white', fontWeight: 'bold', fontSize: '12px' },
            title: sel.name, zIndex: 1000 + index
        });
        dayMarkers.push(marker);
    });

    if (daySelections.length > 1) {
        const request = {
            origin: { lat: daySelections[0].lat, lng: daySelections[0].lng },
            destination: { lat: daySelections[daySelections.length - 1].lat, lng: daySelections[daySelections.length - 1].lng },
            waypoints: daySelections.slice(1, -1).map(s => ({ location: {lat: s.lat, lng: s.lng}, stopover: true })),
            travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, (result, status) => { if (status === 'OK') directionsRenderer.setDirections(result); });
    }
    
    if (userLocationMarker) bounds.extend(userLocationMarker.getPosition());
    if(!bounds.isEmpty()) {
        googleMap.fitBounds(bounds, {top: 20, bottom: 20, left: 20, right: 20});
        if (googleMap.getZoom() > 15) googleMap.setZoom(15);
    }
}

// --- GPS ê´€ë ¨ ë¡œì§ (ê¸°ëŠ¥ ìœ ì§€) ---
function toggleNaviMode() {
    isNaviModeActive = !isNaviModeActive;
    if (isNaviModeActive) {
        if (navigator.geolocation) {
            watchId = navigator.geolocation.watchPosition(handleLocationUpdate, handleLocationError, { enableHighAccuracy: true });
        } else {
            alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            isNaviModeActive = false;
        }
    } else {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        if (userLocationMarker) userLocationMarker.setMap(null);
        userLocationMarker = null;
        clearLiveStatus();
        updateMapForDay(activeDay);
    }
}

function handleLocationUpdate(position) {
    const userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    if (!userLocationMarker) {
        userLocationMarker = new google.maps.Marker({
            position: userLocation, map: googleMap,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 },
            zIndex: 2000
        });
    } else {
        userLocationMarker.setPosition(userLocation);
    }
    googleMap.panTo(userLocation);
    updateLiveStatus(userLocation);
}

function handleLocationError(error) {
    alert(`GPS ì˜¤ë¥˜: ${error.message}`);
    toggleNaviMode();
}

function updateLiveStatus(userLocation) {
    clearLiveStatus();
    const daySelections = selections[activeDay] || {};
    const sortedTimes = Object.keys(daySelections).sort();
    let nextDestinationFound = false;
    const now = new Date();
    const currentTimeStr = now.toTimeString().substring(0, 5);

    sortedTimes.forEach(time => {
        const destination = daySelections[time];
        if (destination && destination.lat) {
            const destLatLng = new google.maps.LatLng(destination.lat, destination.lng);
            const distanceInMeters = google.maps.geometry.spherical.computeDistanceBetween(userLocation, destLatLng);
            const distanceInKm = (distanceInMeters / 1000).toFixed(1);

            const distanceEl = document.querySelector(`.distance-info[data-day="${activeDay}"][data-time="${time}"]`);
            if (distanceEl) {
                distanceEl.innerHTML = `ğŸ“ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ${distanceInKm}km`;
            }

            if (!nextDestinationFound && time > currentTimeStr) {
                const wrapper = document.querySelector(`[data-timeslot-wrapper="${time}"]`);
                if (wrapper) {
                    wrapper.classList.add('live-next-item');
                    const badgeContainer = wrapper.querySelector(`.next-badge-container`);
                    if(badgeContainer) badgeContainer.innerHTML = `<span class="next-badge">NEXT</span>`;
                }
                nextDestinationFound = true;
            }
        }
    });
}

function clearLiveStatus() {
    document.querySelectorAll('.distance-info').forEach(el => el.innerHTML = '');
    document.querySelectorAll('.next-badge-container').forEach(el => el.innerHTML = '');
    document.querySelectorAll('.live-next-item').forEach(el => el.classList.remove('live-next-item'));
}
</script>

</body>
</html>
